---
title: "Pop nat analysis"
author: "Laure Olazcuaga, Nicolas Rode"
date: "`r format(Sys.Date(), '%d-%B-%Y')`"
output: 
  html_document:
    theme: "journal"
    toc: true
    toc_depth: 3
    number_sections: true
    toc_float:
      collapsed: false
      smooth_scroll: false
editor_options: 
  chunk_output_type: console
---


```{r setup, include =FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
devtools::load_all()
```



# DATA 
```{r }
#############################
#PERFORMANCE 
#############################

data_PERF <- import_data(dataset = "DATACOMPLET_PERF.csv", 
                         trait = "performance",
                         remove_testenvt = c("Grape","GF"), 
                         remove_pop = c("WT3"), 
                         remove_rate = NA)

head(data_PERF)
tapply(data_PERF$Nb_adults,list(data_PERF$Original_environment,data_PERF$Generation),length)




#Problem eggs

data_issue_eggs <- data_PERF[data_PERF$Nb_adults>data_PERF$Nb_eggs,]
#Ovservations with more eggs than edults
dim(data_issue_eggs)[1]
#Ovservations with a difference equal or less than two eggs
sum(ifelse((data_issue_eggs$Nb_adults-data_issue_eggs$Nb_eggs)<=2,1,0))

mean(data_issue_eggs[data_issue_eggs$Nb_adults-data_issue_eggs$Nb_eggs<=2,]$Nb_eggs)

tapply(data_issue_eggs$Nb_eggs,data_issue_eggs$Test_environment,length)
tapply(data_issue_eggs$Nb_eggs,data_issue_eggs$Original_environment,length)
tapply(data_PERF$Nb_eggs,data_PERF$Original_environment,length)

mean(data_issue_eggs$Rate)

data_issue_eggs$Nb_eggs
data_issue_eggs$Nb_adults
data_issue_eggs$Rate

#############################
#EMERGENCE RATE
#############################

#When Eggs>Adults: remove data
data_PERF_Rate_removed <- import_data(dataset = "DATACOMPLET_PERF.csv", 
                         trait = "performance",
                         remove_testenvt = c("Grape","GF"), 
                         remove_pop = c("WT3"), 
                         remove_rate = TRUE)
head(data_PERF_Rate_removed)
tapply(data_PERF_Rate_removed$Nb_adults,list(data_PERF_Rate_removed$Original_environment,
                                     data_PERF_Rate_removed$Generation),length)

tapply(data_PERF_Rate_removed$Rate,data_PERF_Rate_removed$Generation,mean)





#When Eggs>Adults: Rate=1
data_PERF_Rate <- import_data(dataset = "DATACOMPLET_PERF.csv", 
                         trait = "performance",
                         remove_testenvt = c("Grape","GF"), 
                         remove_pop = c("WT3"), 
                         remove_rate = "Replace")
tapply(data_PERF_Rate$Nb_adults,list(data_PERF_Rate$Original_environment,
                                     data_PERF_Rate$Generation),length)

tapply(data_PERF_Rate$Rate,data_PERF_Rate$Generation,mean)

###########################
#PREFERENCE 
###########################
data_PREF <- import_data(dataset = "DATACOMPLET_PREF.csv", 
                         trait = "preference",
                         remove_testenvt = NA, 
                         remove_pop = c("WT3"), 
                         remove_rate = NA)

head(data_PREF)
tapply(data_PREF$Nb_eggs,list(data_PREF$Original_environment,data_PREF$Generation),length)


###########################
#PREFERENCE 3 fruits
###########################
levels_test<-levels(data_PREF$Test_environment)
levels_original<-levels(data_PREF$Original_environment)


data_PREF_three <- import_data(dataset = "DATACOMPLET_PREF.csv", 
                         trait = "preference",
                         remove_testenvt = usefun::outersect(levels_test, 
                                                             levels_original), 
                         remove_pop = c("WT3"), 
                         remove_rate = NA)

head(data_PREF_three)
tapply(data_PREF_three$Nb_eggs,list(data_PREF_three$Original_environment,
                                    data_PREF_three$Generation),length)

resume_design<-tapply(as.factor(data_PREF_three$BoxID),list(data_PREF_three$Population,
                                  data_PREF_three$Generation),length)
mean(resume_design[,1], na.rm = TRUE)/3
mean(resume_design[,2], na.rm = TRUE)/3

resume_design<-tapply(data_PERF$Nb_eggs,list(data_PERF$Population,
                                  data_PERF$Generation),length)
mean(resume_design[,1], na.rm = TRUE)/3
mean(resume_design[,2], na.rm = TRUE)/3

dim(data_PREF_three)
dim(data_PREF)
head(data_PREF)


levels(data_PREF$Population)
```



# FECUNDITY
## Exploration data
```{r }

glmm::binomial.glmm()$family.glmm

tapply(data_PERF$Nb_eggs, list(data_PERF$Original_environment, data_PERF$Test_environment, data_PERF$Generation), mean, na.rm = TRUE)


ggplot2::ggplot(data = data_PERF[data_PERF$Generation=="G0",], 
                aes(x = Test_environment, y = Nb_eggs, color = Test_environment)) +
  facet_wrap( ~ Population) +
  geom_point() +
  geom_boxplot() +
  theme_LO_sober


ggplot2::ggplot(data = data_PERF, 
                aes(x = Nb_eggs, fill = Original_environment)) +
  facet_wrap( ~ Generation) +
  geom_histogram(position="identity", alpha=0.5) +
  theme_LO_sober


```


## Analysis
```{r }

#######################################################
## Analysis of genetic effects lm   ###
#######################################################
  
m1 <- aov(log(Nb_eggs+1) ~ pop_gen + hab_gen + SA + 
            Original_environment:Test_environment,
          contrasts = list(Original_environment = "contr.sum", 
                           Test_environment = "contr.sum"), 
          data = data_PERF)
  
  
## F test for SA
(Fratio <- (anova(m1)[3,2]/anova(m1)[4,2])/(1/anova(m1)[4, 1]))
(pvalue <- 1 - pf(Fratio, 1, anova(m1)[4, 1])) 
  
  
#######################################################
## Analysis of non-genetic effects lm   ###
#######################################################
  
m2 <- aov(log(Nb_eggs+1) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0, 
          data = data_PERF)

## F test for SA
(Fratio_Gen <- (anova(m2)[3,2]/anova(m2)[5,2])/(1/anova(m2)[5, 1]))
(pvalue_Gen <- 1 - pf(Fratio_Gen, 1, anova(m2)[5, 1]) )


## F test for SA
(Fratio_NonGen <- (anova(m2)[4,2]/anova(m2)[6,2])/(1/anova(m2)[6, 1]))
(pvalue_NonGen <- 1 - pf(Fratio_NonGen, 1, anova(m2)[6, 1]) )




## Compute R2 for SA 
## Compute R2 = MS Interaction model without SA - MS Interaction model with SA / MS Interaction model without SA
(rsqgen <- 1-anova(m2)[5, 3]/((anova(m2)[3, 2]+anova(m2)[5, 2])/(anova(m2)[3, 1]+anova(m2)[5, 1])))
(rsqng <- 1-anova(m2)[6, 3]/((anova(m2)[4, 2]+anova(m2)[6, 2])/(anova(m2)[4, 1]+anova(m2)[6, 1])))
  


#######################################################
## Extract SA value   ###
#######################################################

#######################################################
## Extract SA value   ###
#######################################################
#Model used previously
m2 <- aov(log(Nb_eggs+1) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0, 
          data = data_PERF)
summary(m2)


#Model with pophab interaction to have corret SA estimates
m3 <- lm(log(Nb_eggs+1)~ pop_gen + hab_gen + SA*IndicG0 + SA  , 
         data = data_PERF)

#Estimates SA
cf <-coef(summary(m3,complete = TRUE)) 
indic <- grep("SA",rownames(cf))
SAcoef <- cf[indic,1]
#names(SAcoef) <- c("SAGen", "SAPlastic")
SAcoef

#Estimates se
indic <- grep("SA",rownames(vcov(m3)))
seSAcoef <- sqrt(diag(vcov(m3)[indic,indic]))
#names(SAcoef) <- c("seSAGen", "seSANonGen")
seSAcoef
  



```


##Plot
```{r }

(PLOT_eggs_G0 <- plot_RTP_residuals(dataset = data_PERF, trait = "Nb_eggs", gen = "G0"))
(PLOT_eggs_G2 <- plot_RTP_residuals(dataset = data_PERF, trait = "Nb_eggs", gen = "G2"))

(PLOT_GEN_eggs_G0 <- plot_Genetic_Nongenetic_residuals(dataset = data_PERF, 
                                                   trait = "Nb_eggs", 
                                                   effect = "Non-genetic"))
(PLOT_GEN_eggs_G2 <- plot_Genetic_Nongenetic_residuals(dataset = data_PERF, 
                                                       trait = "Nb_eggs", 
                                                   effect = "Genetic"))


```


# NUMBER OF ADULTS
## Exploration data
```{r }

tapply(data_PERF$Nb_adults, list(data_PERF$Original_environment, data_PERF$Test_environment, data_PERF$Generation), mean, na.rm = TRUE)


ggplot2::ggplot(data = data_PERF[data_PERF$Generation=="G0",], 
                aes(x = Test_environment, y = Nb_adults, color = Test_environment)) +
  facet_wrap( ~ Population) +
  geom_point() +
  geom_boxplot() +
  theme_LO_sober


ggplot2::ggplot(data = data_PERF[data_PERF$Generation=="G2",], 
                aes(x = Test_environment, y = Nb_adults, color = Test_environment)) +
  facet_wrap( ~ Population) +
  geom_point() +
  geom_boxplot() +
  theme_LO_sober


ggplot2::ggplot(data = data_PERF, 
                aes(x = Nb_adults, fill = Original_environment)) +
  facet_wrap( ~ Generation) +
  geom_histogram(position="identity", alpha=0.5) +
  theme_LO_sober


```


## Analysis
```{r }

#######################################################
## Analysis of genetic effects lm   ###
#######################################################
  
m1 <- aov(log(Nb_adults+1) ~ pop_gen + hab_gen + SA + 
            Original_environment:Test_environment,
          contrasts = list(Original_environment = "contr.sum", 
                           Test_environment = "contr.sum"), 
          data = data_PERF)
  
  
## F test for SA
(Fratio <- (anova(m1)[3,2]/anova(m1)[4,2])/(1/anova(m1)[4, 1]))
(pvalue <- 1 - pf(Fratio, 1, anova(m1)[4, 1])) 
  
  
#######################################################
## Analysis of non-genetic effects lm   ###
#######################################################
  
m2 <- aov(log(Nb_adults+1) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0, 
          data = data_PERF)

## F test for SA
(Fratio_Gen <- (anova(m2)[3,2]/anova(m2)[5,2])/(1/anova(m2)[5, 1]))
(pvalue_Gen <- 1 - pf(Fratio_Gen, 1, anova(m2)[5, 1]) )


## F test for SA
(Fratio_NonGen <- (anova(m2)[4,2]/anova(m2)[6,2])/(1/anova(m2)[6, 1]))
(pvalue_NonGen <- 1 - pf(Fratio_NonGen, 1, anova(m2)[6, 1]) )


## Compute R2 for SA 
## = MS Interaction model without SA - MS Interaction model with SA / MS Interaction model without SA
(r2_SA_genet <- 1-(anova(m2)[5, 3]/((anova(m2)[3, 2]+anova(m2)[5, 2])/(anova(m2)[3, 1]+anova(m2)[5, 1]))))

(r2_SA_nongenet <- 1-(anova(m2)[6, 3]/((anova(m2)[4, 2]+anova(m2)[6, 2])/(anova(m2)[4, 1]+anova(m2)[6, 1]))))

```



## Analysis with eggs as covariable
```{r }

#######################################################
## Should we consider the number of eggs?   ###
#######################################################

# Original
m1 <- aov(log(Nb_adults+1) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0, 
          data = data_PERF)


## Correction for number of eggs
m2 <- aov(log(Nb_adults+1) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0 +
            log(Nb_eggs+1), 
          data = data_PERF)


## With egg score
m3 <- aov(log(Nb_adults+1) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0 +
            EggScore, 
          data = data_PERF)

## Compare with 5 egg scores
m4 <- aov(log(Nb_adults+1) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0 +
            EggScoreFive, 
          data = data_PERF)

## Compare with EggScoreSmall
m5 <- aov(log(Nb_adults+1) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0 +
            EggScoreSmall, 
          data = data_PERF)



MuMIn::model.sel(m1, m2, m3, m4, m5)
# Models are not all fitted to the same data: because 6 tubes without Nb_eggs are missing for m2, m3, m4 and m5


## Cl= The best model is when the number of eggs is considered as a continuous variable
### model m2 provides a better description of the data than model m1 






#######################################################
## Analysis of genetic effects lm   ###
#######################################################
  
m1 <- aov(log(Nb_adults+1) ~ pop_gen + hab_gen + SA + 
            Original_environment:Test_environment + log(Nb_eggs+1),
          contrasts = list(Original_environment = "contr.sum", 
                           Test_environment = "contr.sum"), 
          data = data_PERF)
  
  
## F test for SA
(Fratio <- (anova(m1)[3,2]/anova(m1)[5,2])/(1/anova(m1)[5, 1]))
(pvalue <- 1 - pf(Fratio, 1, anova(m1)[5, 1])) 
  
  
#######################################################
## Analysis of non-genetic effects lm   ###
#######################################################
  
m2 <- aov(log(Nb_adults+1) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0 + 
            log(Nb_eggs+1), 
          data = data_PERF)

## F test for SA
(Fratio_Gen <- (anova(m2)[3,2]/anova(m2)[6,2])/(1/anova(m2)[6, 1]))
(pvalue_Gen <- 1 - pf(Fratio_Gen, 1, anova(m2)[6, 1]) )


## F test for SA
(Fratio_NonGen <- (anova(m2)[5,2]/anova(m2)[7,2])/(1/anova(m2)[7, 1]))
(pvalue_NonGen <- 1 - pf(Fratio_NonGen, 1, anova(m2)[7, 1]) )




## Compute R2 for SA 
## = MS Interaction model without SA - MS Interaction model with SA / MS Interaction model without SA
(r2_SA_genet <- 1-(anova(m2)[6, 3]/((anova(m2)[3, 2]+anova(m2)[6, 2])/(anova(m2)[3, 1]+anova(m2)[6, 1]))))

(r2_SA_nongenet <- 1-(anova(m2)[7, 3]/((anova(m2)[5, 2]+anova(m2)[7, 2])/(anova(m2)[5, 1]+anova(m2)[7, 1]))))
```




##Plot
```{r }

(PLOT_adult_G0 <- plot_RTP_residuals(dataset = data_PERF, trait = "Nb_adults", gen = "G0"))
(PLOT_adult_G2 <- plot_RTP_residuals(dataset = data_PERF, trait = "Nb_adults", gen = "G2"))

(PLOT_GEN_adult_G0 <- plot_Genetic_Nongenetic_residuals(dataset = data_PERF, 
                                                    trait = "Nb_adults", 
                                                    effect = "Non-genetic"))
(PLOT_GEN_adult_G2 <- plot_Genetic_Nongenetic_residuals(dataset = data_PERF, 
                                                    trait = "Nb_adults", 
                                                    effect = "Genetic"))



```





# OFFPSRING PERFORMANCE
## Exploration data
```{r }

tapply(data_PERF_Rate$Rate, list(data_PERF_Rate$Original_environment, 
                                 data_PERF_Rate$Test_environment, 
                                 data_PERF_Rate$Generation), mean, na.rm = TRUE)


ggplot2::ggplot(data = data_PERF_Rate[data_PERF_Rate$Generation=="G0",], 
                aes(x = Test_environment, y = Rate, color = Test_environment)) +
  facet_wrap( ~ Population) +
  geom_point() +
  geom_boxplot() +
  theme_LO_sober

ggplot2::ggplot(data = data_PERF_Rate[data_PERF_Rate$Generation=="G2",], 
                aes(x = Test_environment, y = Rate, color = Test_environment)) +
  facet_wrap( ~ Population) +
  geom_point() +
  geom_boxplot() +
  theme_LO_sober

ggplot2::ggplot(data = data_PERF_Rate, 
                aes(x = Rate, fill = Original_environment)) +
  facet_wrap( ~ Generation) +
  geom_histogram(position="identity", alpha=0.5) +
  theme_LO_sober



lattice::xyplot(Rate~Nb_eggs|Original_environment*Test_environment, 
                data=data_PERF_Rate)
lattice::xyplot(Rate~EggScore|Original_environment*Test_environment, 
                data=data_PERF_Rate)
lattice::bwplot(Rate~EggScore|Original_environment*Test_environment, 
                data=data_PERF_Rate)

lattice::bwplot(Rate~EggScoreFive|Original_environment*Test_environment, 
       data=data_PERF_Rate)

lattice::bwplot(Rate~EggScoreSmall|Original_environment*Test_environment, 
       data=data_PERF_Rate)



AvEmergenceRate <- tapply(data_PERF_Rate$Rate, 
                          list(data_PERF_Rate$EggScoreFive,
                              data_PERF_Rate$Original_environment,
                              data_PERF_Rate$Test_environment),mean)
tapply(data_PERF_Rate$Rate, list(data_PERF_Rate$EggScoreFive,
                                 data_PERF_Rate$Original_environment,
                                 data_PERF_Rate$Test_environment), length)


AvEmergenceRate[, , "Blackberry"][, "Cherry"]/AvEmergenceRate[, , "Blackberry"][, "Blackberry"]
AvEmergenceRate[, , "Cherry"][, "Blackberry"]/AvEmergenceRate[, , "Cherry"][, "Cherry"]

AvEmergenceRate[, , "Blackberry"][, "Cherry"]/AvEmergenceRate[, , "Cherry"][, "Cherry"]

```


## Analysis without eggs
```{r }

#######################################################
## Analysis of genetic effects lm   ###
#######################################################
  
m1 <- aov(asin(sqrt(Rate)) ~ pop_gen + hab_gen + SA + 
            Original_environment:Test_environment,
          contrasts = list(Original_environment = "contr.sum", 
                           Test_environment = "contr.sum"), 
          data = data_PERF_Rate)
  
  
## F test for SA
(Fratio <- (anova(m1)[3,2]/anova(m1)[4,2])/(1/anova(m1)[4, 1]))
(pvalue <- 1 - pf(Fratio, 1, anova(m1)[4, 1])) 



  
  
#######################################################
## Analysis of non-genetic effects lm   ###
#######################################################
  
m2 <- aov(asin(sqrt(Rate)) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0, 
          data = data_PERF_Rate)

## F test for SA
(Fratio_Gen <- (anova(m2)[3,2]/anova(m2)[5,2])/(1/anova(m2)[5, 1]))
(pvalue_Gen <- 1 - pf(Fratio_Gen, 1, anova(m2)[5, 1]) )


## F test for SA
(Fratio_NonGen <- (anova(m2)[4,2]/anova(m2)[6,2])/(1/anova(m2)[6, 1]))
(pvalue_NonGen <- 1 - pf(Fratio_NonGen, 1, anova(m2)[6, 1]) )


  
  
## Compute R2 for SA 
## = MS Interaction model without SA - MS Interaction model with SA / MS Interaction model without SA
(r2_SA_genet <- 1-(anova(m2)[5, 3]/((anova(m2)[3, 2]+anova(m2)[5, 2])/(anova(m2)[3, 1]+anova(m2)[5, 1]))))

(r2_SA_nongenet <- 1-(anova(m2)[6, 3]/((anova(m2)[4, 2]+anova(m2)[6, 2])/(anova(m2)[4, 1]+anova(m2)[6, 1]))))
```


## Variance of eggs as covariable
```{r }

#Goal estimate: 
    # variance across tubes
    # variance across pop 
    # variance among host 

#### Mixte model
lm_vareggs <- lme4::lmer(log(Nb_eggs) ~ 1 +  (1|Population) + (1|Test_environment),
                         data = data_PERF_Rate)
summary(lm_vareggs)
(VAR_TESTENVT<-as.data.frame(lme4::VarCorr(lm_vareggs))$vcov[2])
(VAR_POPULATION<-as.data.frame(lme4::VarCorr(lm_vareggs))$vcov[1])
(VAR_TUBE<-as.data.frame(lme4::VarCorr(lm_vareggs))$vcov[3])

# Var host fruit: 0.01571
# Var population: 0.55243
# Var among tubes: 1.97954

## Extract variance components
VAR <- as.data.frame(lme4::VarCorr(lm_vareggs))$vcov

## Proportion of total variance due to variation among populations
(PropPop <- VAR[1]/sum(VAR))
## Proportion of total variance  due to variation among fruits
(PropObs <- VAR[2]/sum(VAR))
## Proportion of total variance due to within tube variance
(PropVarRes <- VAR[3]/sum(VAR)) 

## Cl: High variance among tubes (78% of total variance)
## Cl: Substantial variation among popupation (22% of total variance)
## Cl: Low variance among hosts (>1% of total variance)


## ANOVA 
## Fit model with ANOVA
fit0 <- aov(log(Nb_eggs) ~ Population + Test_environment, data = data_PERF_Rate) 
anova(fit0)

#Variance among fruits 
(var_fruit <- (anova(fit0)[2,3]-anova(fit0)[3,3])/mean(tapply(data_PERF_Rate$Nb_eggs,
                                                              data_PERF_Rate$Test_environment,length)))
#Variance among populations 
(var_pop <- (anova(fit0)[1,3]-anova(fit0)[3,3])/mean(tapply(data_PERF_Rate$Nb_eggs,
                                                            data_PERF_Rate$Population,length)))
# Within group variance component = Residual variance
(var_tube <- (anova(fit0))[3,3])
sigma(fit0)^2 # the two match






#Plot 
mod1 <- lm(asin(sqrt(Rate)) ~ log(Nb_eggs) * Test_environment, data = data_PERF_Rate)

#Predict data
filldata <- data.frame(Nb_eggs = rep(seq(min(data_PERF_Rate$Nb_eggs),max(data_PERF_Rate$Nb_eggs)),3), 
                       Test_environment = rep(levels(data_PERF_Rate$Test_environment),
                                              each = length(seq(min(data_PERF_Rate$Nb_eggs),
                                                                max(data_PERF_Rate$Nb_eggs)))),
                       Estimates = NA)

filldata$Estimate_transformed <- predict(mod1, newdata=filldata, re.form=~0)
filldata$Estimates <- (sin(filldata$Estimate_transformed))^2


#If y=arcsin(sqrt(x)) then x=(sin(y))^2.

Plot_eggs <- ggplot2::ggplot(data = data_PERF_Rate, 
                aes(x = Nb_eggs, y = Rate, color = Test_environment)) +
  geom_point(size = 0.7)  +
  geom_line(data = filldata, aes(x = Nb_eggs, 
                                y = Estimates, 
                               colour = Test_environment), size = 0.9) + 
  scale_color_manual(name="Test fruit",   
                       breaks=c("Blackberry","Cherry","Strawberry"),
                       labels=c("Blackberry","Cherry","Strawberry"),
                       values=c("#301934","#BC3C6D", "#3FAA96"),
                       drop=FALSE) + 
  ylab("Offspring performance") +
  xlab("Number of eggs") +
  theme_LO_sober

 cowplot::save_plot(file =here::here("figures", "FigSX_DensityEggs_Effect.pdf"),
                   Plot_eggs,
                   base_height = 12/cm(1), base_width = 14/cm(1), dpi = 610)


 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 ######## Disucssion avec Nico 
var(log((data_PERF_Rate$Nb_adults+1)^2))
var(log((data_PERF_Rate$Nb_eggs+1)))


var(log((data_PERF_Rate$Nb_adults+1)))
var(log((data_PERF_Rate$Nb_eggs+1)))

var(log((data_PERF$Nb_adults)))
var(log((data_PERF$Nb_eggs)))

#The coefficient of variation (CV) is a statistical measure of the relative dispersion of data points in a data series around the mean. 

sd(data_PERF_Rate$Nb_adults[data_PERF_Rate$Generation=="G0"])/mean(data_PERF_Rate$Nb_adults[data_PERF_Rate$Generation=="G0"])
sd(data_PERF_Rate$Nb_eggs[data_PERF_Rate$Generation=="G0"])/mean(data_PERF_Rate$Nb_eggs[data_PERF_Rate$Generation=="G0"])



sd(data_PERF_Rate$Nb_adults[data_PERF_Rate$Generation=="G2"])/mean(data_PERF_Rate$Nb_adults[data_PERF_Rate$Generation=="G2"])
sd(data_PERF_Rate$Nb_eggs[data_PERF_Rate$Generation=="G2"])/mean(data_PERF_Rate$Nb_eggs[data_PERF_Rate$Generation=="G2"])


# 
# 
# sd(asin(sqrt(data_PERF_Rate$Rate[data_PERF_Rate$Generation=="G0"])))/mean(asin(sqrt(data_PERF_Rate$Rate[data_PERF_Rate$Generation=="G0"])))
# sd(asin(sqrt(data_PERF_Rate$Rate[data_PERF_Rate$Generation=="G2"])))/mean(asin(sqrt(data_PERF_Rate$Rate[data_PERF_Rate$Generation=="G2"])))
# 
# 
# sd(log(data_PERF_Rate$Nb_eggs[data_PERF_Rate$Generation=="G0"]))/mean(log(data_PERF_Rate$Nb_eggs[data_PERF_Rate$Generation=="G0"]))
# sd(log(data_PERF_Rate$Nb_eggs[data_PERF_Rate$Generation=="G0"]))/mean(log(data_PERF_Rate$Nb_eggs[data_PERF_Rate$Generation=="G0"])) 



# 
# sd(data_PERF_Rate$Rate[data_PERF_Rate$Generation=="G0"])/mean(data_PERF_Rate$Rate[data_PERF_Rate$Generation=="G0"])
# sd(data_PERF_Rate$Rate[data_PERF_Rate$Generation=="G2"])/mean(data_PERF_Rate$Rate[data_PERF_Rate$Generation=="G2"])
# 
# 
# sd(data_PERF_Rate$Nb_eggs[data_PERF_Rate$Generation=="G0"])/mean(data_PERF_Rate$Nb_eggs[data_PERF_Rate$Generation=="G0"])
# sd(data_PERF_Rate$Nb_eggs[data_PERF_Rate$Generation=="G0"])/mean(data_PERF_Rate$Nb_eggs[data_PERF_Rate$Generation=="G0"])


sd(data_PERF_Rate$Rate)/mean(data_PERF_Rate$Rate)
sd(data_PERF_Rate$Nb_eggs)/mean(data_PERF_Rate$Nb_eggs)

```




## Analysis with eggs as covariable
```{r }
#######################################################
## Should we consider the number of eggs?   ###
#######################################################

# Original
m1 <- aov(asin(sqrt(Rate)) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0, 
          data = data_PERF_Rate)



## Correction for number of eggs
m2 <- aov(asin(sqrt(Rate)) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0 +
            log(Nb_eggs), 
          data = data_PERF_Rate)




## With egg score
m3 <- aov(asin(sqrt(Rate)) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0 +
            EggScore, 
          data = data_PERF_Rate)

## Compare with 5 egg scores
m4 <- aov(asin(sqrt(Rate)) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0 +
            EggScoreFive, 
          data = data_PERF_Rate)

## Compare with EggScoreSmall
m5 <- aov(asin(sqrt(Rate)) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0 +
            EggScoreSmall, 
          data = data_PERF_Rate)

## Correction for number of eggs
m6 <- aov(asin(sqrt(Rate)) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0 +
            Nb_eggs, 
          data = data_PERF_Rate)


data_PERF_Rate$Square_NbEggs <- data_PERF_Rate$Nb_eggs^2
## Correction for number of eggs
m7 <- aov(asin(sqrt(Rate)) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0 +
            Nb_eggs + Square_NbEggs, 
          data = data_PERF_Rate)


## Correction for number of eggs
m8 <- aov(asin(sqrt(Rate)) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0 +
            Square_NbEggs, 
          data = data_PERF_Rate)

MuMIn::model.sel(m1, m2, m3, m4, m5, m6, m7, m8)

## Cl= The best model is when the number of eggs is considered as a continuous variable
### model m2 provides a better description of the data than model m1 







#######################################################
## Analysis of genetic effects lm   ###
#######################################################
  
m1 <- aov(asin(sqrt(Rate)) ~ pop_gen + hab_gen + SA + 
            Original_environment:Test_environment +
            log(Nb_eggs),
          contrasts = list(Original_environment = "contr.sum", 
                           Test_environment = "contr.sum"), 
          data = data_PERF_Rate)
  
  

## F test for SA
(Fratio <- (anova(m1)[3,2]/anova(m1)[5,2])/(1/anova(m1)[5, 1]))
(pvalue <- 1 - pf(Fratio, 1, anova(m1)[5, 1])) 

## Compute R2 = MS Interaction model without SA - MS Interaction model with SA / MS Interaction model without SA
(rsqgen <- 1-anova(m1)[5, 3]/((anova(m1)[3, 2]+anova(m1)[4, 2])/(anova(m1)[3, 1]+anova(m1)[4, 1])))


  
#######################################################
## Analysis of non-genetic effects lm   ###
#######################################################
  
m2 <- aov(asin(sqrt(Rate)) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0 +
            log(Nb_eggs), 
          data = data_PERF_Rate)


## F test for SA
(Fratio_Gen <- (anova(m2)[3,2]/anova(m2)[6,2])/(1/anova(m2)[6, 1]))
(pvalue_Gen <- 1 - pf(Fratio_Gen, 1, anova(m2)[6, 1]) )


## F test for SA
(Fratio_NonGen <- (anova(m2)[5,2]/anova(m2)[7,2])/(1/anova(m2)[7, 1]))
(pvalue_NonGen <- 1 - pf(Fratio_NonGen, 1, anova(m2)[7, 1]) )


# Compute R2 = MS Interaction model without SA - MS Interaction model with SA / MS Interaction model without SA
rsqgen <- 1-anova(m2)[6, 3]/((anova(m2)[3, 2]+anova(m2)[6, 2])/(anova(m2)[3, 1]+anova(m2)[6, 1]))
rsqng <- 1-anova(m2)[7, 3]/((anova(m2)[5, 2]+anova(m2)[7, 2])/(anova(m2)[5, 1]+anova(m2)[7, 1]))
  

## Compute R2 for SA 
## = MS Interaction model without SA - MS Interaction model with SA / MS Interaction model without SA
(r2_SA_genet <- 1-(anova(m2)[6, 3]/((anova(m2)[3, 2]+anova(m2)[6, 2])/(anova(m2)[3, 1]+anova(m2)[6, 1]))))

(r2_SA_nongenet <- 1-(anova(m2)[7, 3]/((anova(m2)[5, 2]+anova(m2)[7, 2])/(anova(m2)[5, 1]+anova(m2)[7, 1]))))





#######################################################
## Extract SA value   ###
#######################################################
#Model used previously
m2 <- aov(asin(sqrt(Rate)) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0 +
            log(Nb_eggs), 
          data = data_PERF_Rate)
summary(m2)

#Model with pophab interaction to have corret SA estimates
m3 <- lm(asin(sqrt(Rate)) ~ pop_gen + hab_gen + SA*IndicG0 + SA  + log(Nb_eggs), 
         data = data_PERF_Rate)

#Estimates SA
cf <-coef(summary(m3,complete = TRUE)) 
indic <- grep("SA",rownames(cf))
SAcoef <- cf[indic,1]
#names(SAcoef) <- c("SAGen", "SANonGen")
SAcoef

#Estimates se
indic <- grep("SA",rownames(vcov(m3)))
seSAcoef <- sqrt(diag(vcov(m3)[indic,indic]))
#names(SAcoef) <- c("seSAGen", "seSANonGen")
seSAcoef

  



```


## Heterogeneity across populations
```{r }
data_Rate_G2 <- data_PERF_Rate[data_PERF_Rate$Generation=="G2",]
data_Rate_G2 <- data_Rate_G2[complete.cases(data_Rate_G2$Rate), ]

  
m0 <- lm(Rate~Original_environment*Test_environment, data=data_Rate_G2,)

summary(m0)

tapply(data_Rate_G2$Rate, 
       list(data_Rate_G2$Original_environment, 
            data_Rate_G2$Test_environment), mean)

tapply(data_Rate_G2$Rate, 
       list(data_Rate_G2$Original_environment, 
            data_Rate_G2$Test_environment), var)

range(data_Rate_G2$Nb_adults, na.rm = TRUE)

## Check number of eggs and adults
tapply(data_Rate_G2$Nb_eggs, 
       list(data_Rate_G2$Original_environment, 
            data_Rate_G2$Test_environment), mean)

tapply(data_Rate_G2$Nb_adults, 
       list(data_Rate_G2$Original_environment, 
            data_Rate_G2$Test_environment), mean)

## Check for the presence of negative correlations
m1 <- lm(asin(sqrt(Rate)) ~ Population + Test_environment,
         data=data_Rate_G2)
data_Rate_G2$resid <- residuals(m1)

meanbypopbytestenv <- as.data.frame(tapply(data_Rate_G2$resid, 
                                           list(data_Rate_G2$Population,
                                                data_Rate_G2$Test_environment), mean))


## Cherry ~ Blackberry
plot(meanbypopbytestenv$Blackberry, 
     meanbypopbytestenv$Cherry, 
     col=as.numeric(data_Rate_G2$Original_environment[match(rownames(meanbypopbytestenv),
                                                    data_Rate_G2$Population)]), 
     xlab="Blackberry", ylab="Cherry", pch=16)
legend("topright", levels(data_Rate_G2$Original_environment), 
       col=as.numeric(as.factor(levels(data_Rate_G2$Original_environment))), pch=16)

## Strawberry ~ Cherry
plot(meanbypopbytestenv$Cherry,  meanbypopbytestenv$Strawberry, col=as.numeric(data_Rate_G2$Original_environment[match(rownames(meanbypopbytestenv), data_Rate_G2$Population)]), xlab="Cherry", ylab="Strawberry", pch=16)
legend("bottomright", levels(data_Rate_G2$Original_environment), col=as.numeric(as.factor(levels(data_Rate_G2$Original_environment))), pch=16)

## Strawberry ~ Blackberry
plot(meanbypopbytestenv$Blackberry, meanbypopbytestenv$Strawberry, col=as.numeric(data_Rate_G2$Original_environment[match(rownames(meanbypopbytestenv), data_Rate_G2$Population)]), xlab="Blackberry", ylab="Strawberry", pch=16)
legend("topright", levels(data_Rate_G2$Original_environment), col=as.numeric(as.factor(levels(data_Rate_G2$Original_environment))), pch=16)



```



##Plot
```{r }

(PLOT_rate_G0 <- plot_RTP_residuals(dataset = data_PERF_Rate, trait = "Rate", gen = "G0"))
(PLOT_rate_G2 <- plot_RTP_residuals(dataset = data_PERF_Rate, trait = "Rate", gen = "G2"))

(PLOT_GEN_rate_G0 <- plot_Genetic_Nongenetic_residuals(dataset = data_PERF_Rate, 
                                                    trait = "Rate", 
                                                    effect = "Non-genetic"))
(PLOT_GEN_rate_G2 <- plot_Genetic_Nongenetic_residuals(dataset = data_PERF_Rate, 
                                                    trait = "Rate", 
                                                    effect = "Genetic"))

```





# OVIOSITION PREFERENCE 
## Twelve fruits
### Exploration data
```{r }

tapply(data_PREF$Nb_eggs, list(data_PREF$Original_environment, 
                                 data_PREF$Test_environment, 
                                 data_PREF$Generation), mean, na.rm = TRUE)


ggplot2::ggplot(data = data_PREF, 
                aes(x = Test_environment, y = Nb_eggs, color = Test_environment)) +
  facet_wrap( ~ Population) +
  geom_point() +
  geom_boxplot() +
  theme_LO_sober


ggplot2::ggplot(data = data_PREF, 
                aes(x = Nb_eggs, fill = Original_environment)) +
  facet_wrap( ~ Generation) +
  geom_histogram(position="identity", alpha=0.5) +
  theme_LO_sober


```


### Analysis
```{r }

#######################################################
## Analysis of genetic effects lm   ###
#######################################################
  
m1 <- aov(log(Nb_eggs+1) ~ pop_gen + hab_gen + SA + 
            Original_environment:Test_environment,
          contrasts = list(Original_environment = "contr.sum", 
                           Test_environment = "contr.sum"), 
          data = data_PREF)
  
  
## F test for SA
(Fratio <- (anova(m1)[3,2]/anova(m1)[4,2])/(1/anova(m1)[4, 1]))
(pvalue <- 1 - pf(Fratio, 1, anova(m1)[4, 1])) 
  
  
#######################################################
## Analysis of non-genetic effects lm   ###
#######################################################
  
m2 <- aov(log(Nb_eggs+1) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0 +
            BoxID, 
          data = data_PREF)

## F test for SA
(Fratio_Gen <- (anova(m2)[3,2]/anova(m2)[6,2])/(1/anova(m2)[6, 1]))
(pvalue_Gen <- 1 - pf(Fratio_Gen, 1, anova(m2)[6, 1]) )


## F test for SA
(Fratio_NonGen <- (anova(m2)[5,2]/anova(m2)[7,2])/(1/anova(m2)[7, 1]))
(pvalue_NonGen <- 1 - pf(Fratio_NonGen, 1, anova(m2)[7, 1]) )




## Compute R2 for SA 
## = MS Interaction model without SA - MS Interaction model with SA / MS Interaction model without SA
(r2_SA_genet <- 1-(anova(m2)[6, 3]/((anova(m2)[3, 2]+anova(m2)[6, 2])/(anova(m2)[3, 1]+anova(m2)[6, 1]))))

(r2_SA_nongenet <- 1-(anova(m2)[7, 3]/((anova(m2)[5, 2]+anova(m2)[7, 2])/(anova(m2)[5, 1]+anova(m2)[7, 1]))))




#Local adaptation pattern: 
lm_val = lm(log(Nb_eggs+1) ~ Test_environment + Population + SA + 
                      Test_environment:Original_environment + BoxID, 
                    data = data_PREF[data_PREF$Generation=="G0",])

(Fratio = anova(lm_val)[3,3]/anova(lm_val)[5,3])
(pvalue = 1 - pf(Fratio,anova(lm_val)[3,1],anova(lm_val)[5,1]))
(df1 = anova(lm_val)[3,1])
(df2 = anova(lm_val)[5,1])

lm_val = lm(log(Nb_eggs+1) ~ Test_environment + Population + SA + 
                      Test_environment:Original_environment + BoxID, 
                    data = data_PREF[data_PREF$Generation=="G2",])

(Fratio = anova(lm_val)[3,3]/anova(lm_val)[5,3])
(pvalue = 1 - pf(Fratio,anova(lm_val)[3,1],anova(lm_val)[5,1]))
(df1 = anova(lm_val)[3,1])
(df2 = anova(lm_val)[5,1])

```



## Three fruits
### Exploration data
```{r }

tapply(data_PREF_three$Nb_eggs, list(data_PREF_three$Original_environment, 
                                 data_PREF_three$Test_environment, 
                                 data_PREF_three$Generation), mean, na.rm = TRUE)


ggplot2::ggplot(data = data_PREF_three, 
                aes(x = Test_environment, y = Nb_eggs, color = Test_environment)) +
  facet_wrap( ~ Population) +
  geom_point() +
  geom_boxplot() +
  theme_LO_sober


ggplot2::ggplot(data = data_PREF_three, 
                aes(x = Nb_eggs, fill = Original_environment)) +
  facet_wrap( ~ Generation) +
  geom_histogram(position="identity", alpha=0.5) +
  theme_LO_sober


```


### Analysis
```{r }

#######################################################
## Analysis of genetic effects lm   ###
#######################################################
  
m1 <- aov(log(Nb_eggs+1) ~ pop_gen + hab_gen + SA + 
            Original_environment:Test_environment +
            BoxID,
          contrasts = list(Original_environment = "contr.sum", 
                           Test_environment = "contr.sum"), 
          data = data_PREF_three)
  
  
## F test for SA
(Fratio <- (anova(m1)[3,2]/anova(m1)[5,2])/(1/anova(m1)[5, 1]))
(pvalue <- 1 - pf(Fratio, 1, anova(m1)[5, 1])) 
  
  
#######################################################
## Analysis of non-genetic effects lm   ###
#######################################################
  
m2 <- aov(log(Nb_eggs+1) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0 +
            BoxID, 
          data = data_PREF_three)

## F test for SA
(Fratio_Gen <- (anova(m2)[3,2]/anova(m2)[6,2])/(1/anova(m2)[6, 1]))
(pvalue_Gen <- 1 - pf(Fratio_Gen, 1, anova(m2)[6, 1]) )


## F test for SA
(Fratio_NonGen <- (anova(m2)[5,2]/anova(m2)[7,2])/(1/anova(m2)[7, 1]))
(pvalue_NonGen <- 1 - pf(Fratio_NonGen, 1, anova(m2)[7, 1]) )


## Compute R2 for SA 
# ## = MS Interaction model without SA - MS Interaction model with SA / MS Interaction model without SA
# (r2_SA_genet <- 1-(anova(m2)[6, 3]/((anova(m2)[3, 2]+anova(m2)[6, 2])/(anova(m2)[3, 1]+anova(m2)[6, 1]))))
# 
# (r2_SA_nongenet <- 1-(anova(m2)[7, 3]/((anova(m2)[5, 2]+anova(m2)[7, 2])/(anova(m2)[5, 1]+anova(m2)[7, 1]))))
  ## Compute R2 = MS Interaction model without SA - MS Interaction model with SA / MS Interaction model without SA
rsqgen <- 1-anova(m2)[6, 3]/((anova(m2)[3, 2]+anova(m2)[6, 2])/(anova(m2)[3, 1]+anova(m2)[6, 1]))
rsqng <- 1-anova(m2)[7, 3]/((anova(m2)[5, 2]+anova(m2)[7, 2])/(anova(m2)[5, 1]+anova(m2)[7, 1]))
  rsqgen
  rsqng

  
  
  
  

#######################################################
## Extract SA value   ###
#######################################################
#Model used previously
m2 <- aov(log(Nb_eggs+1) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0 +
            BoxID, 
          data = data_PREF_three)
summary(m2)

#but without interaction to have correct estimate of SA 
m3 <- lm(log(Nb_eggs+1) ~ pop_gen + hab_gen +  SA:IndicG0 + SA +
           BoxID, 
          data = data_PREF_three)
# Pour les SA:
# summary(m3)
# coef(m3)
cf <-coef(summary(m3,complete = TRUE)) 
indic <- grep("SA",rownames(cf))
SAcoef <- cf[indic,1]
names(SAcoef) <- c("SAGen", "SANonGen")
SAcoef

#With Nico
m3 <- lm(log(Nb_eggs+1) ~ pop_gen + hab_gen + SA:IndicG0 + SA + BoxID,
data = data_PREF_three)
summary(m3)
coef(m3)
vcov(m3)[420:423,420:423]

test <- vcov(m3)[418:423,418:423]
sqrt(test)
#se SA0IndicG0 = 0.11936296 avec lmer 
#se SA0:IndicG0 = 1.16490 avec lm (sans interaction)


#MYSELF
m3 <- lm(log(Nb_eggs+1) ~ pop_gen + hab_gen + SA*IndicG0 + SA  + BoxID, data = data_PREF_three)

#Estimates SA
cf <-coef(summary(m3,complete = TRUE)) 
indic <- grep("SA",rownames(cf))
SAcoef <- cf[indic,1]
#names(SAcoef) <- c("SAGen", "SANonGen")
SAcoef

#Estimates se
indic <- grep("SA",rownames(vcov(m3)))
seSAcoef <- sqrt(diag(vcov(m3)[indic,indic]))
#names(SAcoef) <- c("seSAGen", "seSANonGen")
seSAcoef






```



### Plot
```{r }

(PLOT_pref_G0 <- plot_RTP_residuals(dataset = data_PREF_three, 
                                    trait = "Nb_eggs", gen = "G0"))
(PLOT_pref_G2 <- plot_RTP_residuals(dataset = data_PREF_three, 
                                    trait = "Nb_eggs", gen = "G2"))



(PLOT_GEN_pref_G0 <- plot_Genetic_Nongenetic_residuals(dataset = data_PREF_three, 
                                    trait = "Nb_eggs", effect = "Non-genetic"))
(PLOT_GEN_pref_G2 <- plot_Genetic_Nongenetic_residuals(dataset = data_PREF_three, 
                                    trait = "Nb_eggs", effect = "Genetic"))



```





# PLOT LOCAL ADAPTATION
```{r }
legend <- lemon::g_legend(PLOT_pref_G0)
# 

# 
# ## ALL GENERATIONS 
# LOCAL_ADAPTATION_PLOT <- cowplot::ggdraw() + 
#   cowplot::draw_plot(PLOT_pref_G0 + theme(legend.position = "none", 
#                                         plot.title = element_blank()), 
#             x = 0.01, y = 0.5, width = 0.25, height = 0.45) + 
#   cowplot::draw_plot(PLOT_eggs_G0 + theme(legend.position = "none", 
#                                         plot.title = element_blank()), 
#             x = 0.31, y = 0.5, width = 0.25, height = 0.45) + 
#   cowplot::draw_plot(PLOT_rate_G0 + theme(legend.position = "none", 
#                                         plot.title = element_blank()), 
#             x = 0.61, y = 0.5, width = 0.25, height = 0.45) + 
#   cowplot::draw_plot(legend, x = 0.93, y = 0.5, width = 0.0001, height = 0.0001) + 
#   cowplot::draw_plot(PLOT_pref_G2 + theme(legend.position = "none", 
#                                         plot.title = element_blank()), 
#             x = 0.01, y = 0, width = 0.25, height = 0.45) + 
#   cowplot::draw_plot(PLOT_eggs_G2 + theme(legend.position = "none", 
#                                         plot.title = element_blank()), 
#             x = 0.31, y = 0, width = 0.25, height = 0.45) + 
#   cowplot::draw_plot(PLOT_rate_G2 + theme(legend.position = "none", 
#                                         plot.title = element_blank()), 
#             x = 0.61, y = 0, width = 0.25, height = 0.45) + 
#   cowplot::draw_plot_label(c("Generation: G0","Generation: G0","Generation: G1", "A", "B", "C", " ",
#                     "Generation: G2","Generation: G2","Generation: G3", "D", "E", "F", " "),  
#                   x = c(0.1,0.4,0.7, 0.01, 0.30, 0.61, 0.92, 0.10,0.4,0.7, 0.01, 0.3, 0.61, 0.92), 
#                   y = c(1,1,1, 0.98, 0.98, 0.98, 0.98, 0.5, 0.5, 0.5, 0.48, 0.48, 0.48, 0.48), 
#                   hjust = c(0,0,0,0,0,0,0,0,0,0,0,0,0,0), 
#                   vjust = c(1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5),
#                   size = 16) 
#  LOCAL_ADAPTATION_PLOT



## ALL GENERATIONS 
LOCAL_ADAPTATION_PLOT <- cowplot::ggdraw() + 
  cowplot::draw_plot(PLOT_pref_G0 + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.0, y = 0.66, width = 0.4, height = 0.3) + 
  cowplot::draw_plot(PLOT_eggs_G0 + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.0, y = 0.33, width = 0.4, height = 0.3) + 
  cowplot::draw_plot(PLOT_rate_G0 + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.01, y = 0, width = 0.4, height = 0.3) + 
  cowplot::draw_plot(PLOT_pref_G2 + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.44, y = 0.66, width = 0.4, height = 0.3) + 
  cowplot::draw_plot(PLOT_eggs_G2 + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.44, y = 0.33, width = 0.4, height = 0.3) + 
  cowplot::draw_plot(PLOT_rate_G2 + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.44, y = 0, width = 0.4, height = 0.3) + 
  cowplot::draw_plot(legend, x = 0.915, y = 0.5, width = 0.000001, height = 0.000001) + 
  cowplot::draw_plot_label(c("Generation: G0/G1","Generation: G2/G3","A", "B", "C",
                    "D", "E", "F"),  
                  x = c(0.12,0.55, 0, 0.44, 0, 0.44, 0, 0.44 ), 
                  y = c(1,1, 0.99, 0.99, 0.66,  0.66, 0.33, 0.33), 
                  hjust = c(0,0,0,0,0,0,0,0), 
                  vjust = c(1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5),
                  size = 18) 
 LOCAL_ADAPTATION_PLOT
 


 cowplot::save_plot(file =here::here("figures", "Supplements_FigS4_Local_Adaptation_Residuals.pdf"),
                   LOCAL_ADAPTATION_PLOT,
                   base_height = 28/cm(1), base_width = 22/cm(1), dpi = 610)




```




# PLOT GENETIC vs PLASTIC
```{r }
legend <- lemon::g_legend(PLOT_pref_G0)

# Genetic_NonGenetic_PLOT <- cowplot::ggdraw() + 
#   cowplot::draw_plot(PLOT_GEN_pref_G2 + theme(legend.position = "none", 
#                                         plot.title = element_blank()), 
#             x = 0.01, y = 0.5, width = 0.25, height = 0.45) + 
#   cowplot::draw_plot(PLOT_GEN_eggs_G2 + theme(legend.position = "none", 
#                                         plot.title = element_blank()), 
#             x = 0.31, y = 0.5, width = 0.25, height = 0.45) + 
#   cowplot::draw_plot(PLOT_GEN_rate_G2 + theme(legend.position = "none", 
#                                         plot.title = element_blank()), 
#             x = 0.61, y = 0.5, width = 0.25, height = 0.45) + 
#   cowplot::draw_plot(legend, x = 0.93, y = 0.5, width = 0.0001, height = 0.0001) + 
#   cowplot::draw_plot(PLOT_GEN_pref_G0 + theme(legend.position = "none", 
#                                         plot.title = element_blank()), 
#             x = 0.01, y = 0, width = 0.25, height = 0.45) + 
#   cowplot::draw_plot(PLOT_GEN_eggs_G0 + theme(legend.position = "none", 
#                                         plot.title = element_blank()), 
#             x = 0.31, y = 0, width = 0.25, height = 0.45) + 
#   cowplot::draw_plot(PLOT_GEN_rate_G0 + theme(legend.position = "none", 
#                                         plot.title = element_blank()), 
#             x = 0.61, y = 0, width = 0.25, height = 0.45) + 
#   cowplot::draw_plot_label(c("Genetic effects", "A", "B", "C", " ",
#                     "Plastic effects", "D", "E", "F", " "),  
#                   x = c(0.4, 0.01, 0.30, 0.61, 0.92, 0.4, 0.01, 0.3, 0.61, 0.92), 
#                   y = c(1, 0.98, 0.98, 0.98, 0.98, 0.5, 0.48, 0.48, 0.48, 0.48), 
#                   hjust = c(0,0,0,0,0,0,0,0,0,0), 
#                   vjust = c(1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5),
#                   size = 16) 
#  Genetic_NonGenetic_PLOT
 
 
# 
# 
# cowplot::save_plot(file =here::here("figures", "GENETIC_NONGENETIC_First_Third.pdf"),
#                   Genetic_NonGenetic_PLOT,
#                   base_height = 18/cm(1), base_width = 34/cm(1), dpi = 610)
# 
# 
# 

 
## ALL GENERATIONS 
Genetic_NonGenetic_PLOT <- cowplot::ggdraw() + 
  cowplot::draw_plot(PLOT_GEN_pref_G2 + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.0, y = 0.66, width = 0.4, height = 0.3) + 
  cowplot::draw_plot(PLOT_GEN_eggs_G2 + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.0, y = 0.33, width = 0.4, height = 0.3) + 
  cowplot::draw_plot(PLOT_GEN_rate_G2 + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.01, y = 0, width = 0.4, height = 0.3) + 
  cowplot::draw_plot(PLOT_GEN_pref_G0 + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.44, y = 0.66, width = 0.4, height = 0.3) + 
  cowplot::draw_plot(PLOT_GEN_eggs_G0 + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.44, y = 0.33, width = 0.4, height = 0.3) + 
  cowplot::draw_plot(PLOT_GEN_rate_G0 + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.44, y = 0, width = 0.4, height = 0.3) + 
  cowplot::draw_plot(legend, x = 0.915, y = 0.5, width = 0.000001, height = 0.000001) + 
  cowplot::draw_plot_label(c("Genetic effects","Plastic effects","A", "B", "C",
                    "D", "E", "F"),  
                  x = c(0.12,0.55, 0, 0.44, 0, 0.44, 0, 0.44 ), 
                  y = c(1,1, 0.99, 0.99, 0.66,  0.66, 0.33, 0.33), 
                  hjust = c(0,0,0,0,0,0,0,0), 
                  vjust = c(1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5),
                  size = 18) 
 Genetic_NonGenetic_PLOT


 #
 cowplot::save_plot(file =here::here("figures", "Fig5_GENETIC_NONGENETIC_First_Third.pdf"),
                   Genetic_NonGenetic_PLOT,
                   base_height = 28/cm(1), base_width = 22/cm(1), dpi = 610)

```


# PLOT POP EFFECT - HETEROGENEITY
```{r }
# library("dplyr")
PPMR_ALL_Pref_Stim_G0 <- plot_realdata(dataset = data_PERF, 
                                        trait="Nb_eggs" ,
                                        printcor = TRUE,
                                        gen = "G0" , 
                                        xlim = c(0,94), 
                                        ylim = c(0,94), 
                                        formula_Blanquart="log(Nb_eggs+1) ~  Test_environment + Population + SA + Test_environment:Original_environment",
                                        xaxis_labelprint = "Fecundity in original",
                                        yaxis_labelprint = "Fecundity in alternative")

PPMR_ALL_Pref_Stim_G2 <- plot_realdata(dataset = data_PERF, 
                                        printcor = TRUE,
                                        trait="Nb_eggs" ,
                                        formula_Blanquart="log(Nb_eggs+1) ~  Test_environment + Population + SA + Test_environment:Original_environment",
                                        gen = "G2" , 
                                        xaxis_labelprint = "Fecundity in original",
                                        yaxis_labelprint = "Fecundity in alternative")


PPMR_ALL_Pref_G0 <- plot_realdata(dataset = data_PREF_three, 
                                        printcor = TRUE,
                                        trait="Nb_eggs" ,
                                        formula_Blanquart="log(Nb_eggs+1) ~ Test_environment + Population + SA + 
                    Test_environment:Original_environment + BoxID",
                                        gen = "G0" , 
                                        xaxis_labelprint = "Oviposition preference in original",
                                        yaxis_labelprint = "Oviposition preference in alternative")

PPMR_ALL_Pref_G2 <- plot_realdata(dataset = data_PREF_three, 
                                        trait="Nb_eggs" ,
                                        formula_Blanquart="log(Nb_eggs+1) ~ Test_environment + Population + SA + 
                    Test_environment:Original_environment + BoxID",
                                        gen = "G2" ,
                                        printcor = TRUE,
                                        xlim = c(0,80), 
                                        ylim = c(0,80), 
                                        xaxis_labelprint = "Oviposition preference in original",
                                        yaxis_labelprint = "Oviposition preference in alternative")

PPMR_ALL_Perf_G0 <- plot_realdata(dataset = data_PERF_Rate, 
                                         trait="Rate" ,
                                          gen = "G0" , 
                                        printcor = TRUE,
                                        xlim = c(0,1.1), 
                                        ylim = c(0,1.1), 
                                        formula_Blanquart="asin(sqrt(Rate)) ~  Test_environment + Population + SA + log(Nb_eggs) + Test_environment:Original_environment",
                                        xaxis_labelprint = "Offspring performance in original",
                                        yaxis_labelprint = "Offspring performance in alternative")





PPMR_ALL_Perf_G2 <- plot_realdata(dataset = data_PERF_Rate, 
                                        trait="Rate" ,
                                        printcor = TRUE,
                                        gen = "G2" ,
                                  formula_Blanquart="asin(sqrt(Rate)) ~  Test_environment + Population + SA + log(Nb_eggs) + Test_environment:Original_environment",
                                        xlim = c(0,0.7), 
                                        ylim = c(0,0.7), 
                                        xaxis_labelprint = "Offspring performance in original",
                                        yaxis_labelprint = "Offspring performance in alternative")


legend <- lemon::g_legend(PPMR_ALL_Perf_G2)

 
## ALL GENERATIONS 
PPMR_ALL <- cowplot::ggdraw() + 
  cowplot::draw_plot(PPMR_ALL_Pref_G0 + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.0, y = 0.66, width = 0.4, height = 0.3) + 
  cowplot::draw_plot(PPMR_ALL_Pref_Stim_G0 + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.0, y = 0.33, width = 0.4, height = 0.3) + 
  cowplot::draw_plot(PPMR_ALL_Perf_G0 + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.01, y = 0, width = 0.4, height = 0.3) + 
  cowplot::draw_plot(PPMR_ALL_Pref_G2 + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.44, y = 0.66, width = 0.4, height = 0.3) + 
  cowplot::draw_plot(PPMR_ALL_Pref_Stim_G2 + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.44, y = 0.33, width = 0.4, height = 0.3) + 
  cowplot::draw_plot(PPMR_ALL_Perf_G2 + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.44, y = 0, width = 0.4, height = 0.3) + 
  cowplot::draw_plot(legend, x = 0.915, y = 0.5, width = 0.000001, height = 0.000001) + 
  cowplot::draw_plot_label(c("Generation G0/G1","Generation G2/G3","A", "B", "C",
                    "D", "E", "F"),  
                  x = c(0.12,0.55, 0, 0.44, 0, 0.44, 0, 0.44 ), 
                  y = c(1,1, 0.99, 0.99, 0.66,  0.66, 0.33, 0.33), 
                  hjust = c(0,0,0,0,0,0,0,0), 
                  vjust = c(1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5),
                  size = 18) 
 PPMR_ALL

cowplot::save_plot(file =here::here("figures", "Fig4_POP_effect_ALL.pdf"),
                  PPMR_ALL,
                  base_height = 28/cm(1), base_width = 22/cm(1), dpi = 610)


```

