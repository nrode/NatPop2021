---
title: "Pop nat analysis"
author: "Laure Olazcuaga, Nicolas Rode"
date: "`r format(Sys.Date(), '%d-%B-%Y')`"
output: 
  html_document:
    theme: "journal"
    toc: true
    toc_depth: 3
    number_sections: true
    toc_float:
      collapsed: false
      smooth_scroll: false
editor_options: 
  chunk_output_type: console
---


```{r setup, include =FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
devtools::load_all()
```



# DATA 
```{r }
#############################
#PERFORMANCE 
#############################

data_PERF <- import_data(dataset = "DATACOMPLET_PERF.csv", 
                         trait = "performance",
                         remove_testenvt = c("Grape","GF"), 
                         remove_pop = c("WT3"), 
                         remove_rate = NA)

head(data_PERF)
tapply(data_PERF$Nb_adults,list(data_PERF$Original_environment,data_PERF$Generation),length)

#############################
#EMERGENCE RATE
#############################

data_PERF_Rate <- import_data(dataset = "DATACOMPLET_PERF.csv", 
                         trait = "performance",
                         remove_testenvt = c("Grape","GF"), 
                         remove_pop = c("WT3"), 
                         remove_rate = TRUE)
head(data_PERF_Rate)
tapply(data_PERF_Rate$Nb_adults,list(data_PERF_Rate$Original_environment,
                                     data_PERF_Rate$Generation),length)

tapply(data_PERF_Rate$Rate,data_PERF_Rate$Generation,mean)

###########################
#PREFERENCE 
###########################
data_PREF <- import_data(dataset = "DATACOMPLET_PREF.csv", 
                         trait = "preference",
                         remove_testenvt = NA, 
                         remove_pop = c("WT3"), 
                         remove_rate = NA)

head(data_PREF)
tapply(data_PREF$Nb_eggs,list(data_PREF$Original_environment,data_PREF$Generation),length)



###########################
#PREFERENCE 3 fruits
###########################
levels_test<-levels(data_PREF$Test_environment)
levels_original<-levels(data_PREF$Original_environment)


data_PREF_three <- import_data(dataset = "DATACOMPLET_PREF.csv", 
                         trait = "preference",
                         remove_testenvt = usefun::outersect(levels_test, 
                                                             levels_original), 
                         remove_pop = c("WT3"), 
                         remove_rate = NA)

head(data_PREF_three)
tapply(data_PREF_three$Nb_eggs,list(data_PREF_three$Original_environment,
                                    data_PREF_three$Generation),length)

resume_design<-tapply(as.factor(data_PREF_three$BoxID),list(data_PREF_three$Population,
                                  data_PREF_three$Generation),length)
mean(resume_design[,1], na.rm = TRUE)/3
mean(resume_design[,2], na.rm = TRUE)/3

resume_design<-tapply(data_PERF$Nb_eggs,list(data_PERF$Population,
                                  data_PERF$Generation),length)
mean(resume_design[,1], na.rm = TRUE)/3
mean(resume_design[,2], na.rm = TRUE)/3

dim(data_PREF_three)
dim(data_PREF)
head(data_PREF)


levels(data_PREF$Population)
```



# OVIPOSITION STIMULATION
## Exploration data
```{r }

tapply(data_PERF$Nb_eggs, list(data_PERF$Original_environment, data_PERF$Test_environment, data_PERF$Generation), mean, na.rm = TRUE)


ggplot2::ggplot(data = data_PERF[data_PERF$Generation=="G0",], 
                aes(x = Test_environment, y = Nb_eggs, color = Test_environment)) +
  facet_wrap( ~ Population) +
  geom_point() +
  geom_boxplot() +
  theme_LO_sober


ggplot2::ggplot(data = data_PERF, 
                aes(x = Nb_eggs, fill = Original_environment)) +
  facet_wrap( ~ Generation) +
  geom_histogram(position="identity", alpha=0.5) +
  theme_LO_sober


```


## Analysis
```{r }

#######################################################
## Analysis of genetic effects lm   ###
#######################################################
  
m1 <- aov(log(Nb_eggs+1) ~ pop_gen + hab_gen + SA + 
            Original_environment:Test_environment,
          contrasts = list(Original_environment = "contr.sum", 
                           Test_environment = "contr.sum"), 
          data = data_PERF)
  
  
## F test for SA
(Fratio <- (anova(m1)[3,2]/anova(m1)[4,2])/(1/anova(m1)[4, 1]))
(pvalue <- 1 - pf(Fratio, 1, anova(m1)[4, 1])) 
  
  
#######################################################
## Analysis of non-genetic effects lm   ###
#######################################################
  
m2 <- aov(log(Nb_eggs+1) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0, 
          data = data_PERF)

## F test for SA
(Fratio_Gen <- (anova(m2)[3,2]/anova(m2)[5,2])/(1/anova(m2)[5, 1]))
(pvalue_Gen <- 1 - pf(Fratio_Gen, 1, anova(m2)[5, 1]) )


## F test for SA
(Fratio_NonGen <- (anova(m2)[4,2]/anova(m2)[6,2])/(1/anova(m2)[6, 1]))
(pvalue_NonGen <- 1 - pf(Fratio_NonGen, 1, anova(m2)[6, 1]) )




## Compute R2 for SA 
## Compute R2 = MS Interaction model without SA - MS Interaction model with SA / MS Interaction model without SA
(rsqgen <- 1-anova(m2)[5, 3]/((anova(m2)[3, 2]+anova(m2)[5, 2])/(anova(m2)[3, 1]+anova(m2)[5, 1])))
(rsqng <- 1-anova(m2)[6, 3]/((anova(m2)[4, 2]+anova(m2)[6, 2])/(anova(m2)[4, 1]+anova(m2)[6, 1])))
  
  
```


##Plot
```{r }

(PLOT_eggs_G0 <- plot_RTP_residuals(dataset = data_PERF, trait = "Nb_eggs", gen = "G0"))
(PLOT_eggs_G2 <- plot_RTP_residuals(dataset = data_PERF, trait = "Nb_eggs", gen = "G2"))

(PLOT_GEN_eggs_G0 <- plot_Genetic_Nongenetic_residuals(dataset = data_PERF, 
                                                   trait = "Nb_eggs", 
                                                   effect = "Non-genetic"))
(PLOT_GEN_eggs_G2 <- plot_Genetic_Nongenetic_residuals(dataset = data_PERF, 
                                                       trait = "Nb_eggs", 
                                                   effect = "Genetic"))

###PLOT 
(PAIR_BLACK_CHERRY_G2_EGGS <- plot_PairwisePOP_residuals(dataset = data_PERF, 
                                                           trait = "Nb_eggs", gen = "G2", 
                                                           fruit1 = "Cherry", fruit2 = "Blackberry"))

(PAIR_CHERRY_STRAW_G2_EGGS  <- plot_PairwisePOP_residuals(dataset = data_PERF, 
                                                            trait = "Nb_eggs", gen = "G2",
                                                            fruit1 = "Strawberry", fruit2 = "Cherry"))

(PAIR_STRW_BLACK_G2_EGGS  <- plot_PairwisePOP_residuals(dataset = data_PERF, 
                                                          trait = "Nb_eggs", gen = "G2",
                                                          fruit1 = "Blackberry", fruit2 = "Strawberry"))




###PLOT 
(PAIR_BLACK_CHERRY_EGGS <- plot_PairwisePOP_residuals(dataset = data_PERF, 
                                                           trait = "Nb_eggs", gen = "Both", 
                                                           fruit1 = "Cherry", fruit2 = "Blackberry"))

(PAIR_CHERRY_STRAW_EGGS  <- plot_PairwisePOP_residuals(dataset = data_PERF, 
                                                            trait = "Nb_eggs", gen = "Both",
                                                            fruit1 = "Strawberry", fruit2 = "Cherry"))

(PAIR_STRW_BLACK_EGGS  <- plot_PairwisePOP_residuals(dataset = data_PERF, 
                                                          trait = "Nb_eggs", gen = "Both",
                                                          fruit1 = "Blackberry", 
                                                     fruit2 = "Strawberry"))
```



# NUMBER OF ADULTS
## Exploration data
```{r }

tapply(data_PERF$Nb_adults, list(data_PERF$Original_environment, data_PERF$Test_environment, data_PERF$Generation), mean, na.rm = TRUE)


ggplot2::ggplot(data = data_PERF[data_PERF$Generation=="G0",], 
                aes(x = Test_environment, y = Nb_adults, color = Test_environment)) +
  facet_wrap( ~ Population) +
  geom_point() +
  geom_boxplot() +
  theme_LO_sober


ggplot2::ggplot(data = data_PERF[data_PERF$Generation=="G2",], 
                aes(x = Test_environment, y = Nb_adults, color = Test_environment)) +
  facet_wrap( ~ Population) +
  geom_point() +
  geom_boxplot() +
  theme_LO_sober


ggplot2::ggplot(data = data_PERF, 
                aes(x = Nb_adults, fill = Original_environment)) +
  facet_wrap( ~ Generation) +
  geom_histogram(position="identity", alpha=0.5) +
  theme_LO_sober


```


## Analysis
```{r }

#######################################################
## Analysis of genetic effects lm   ###
#######################################################
  
m1 <- aov(log(Nb_adults+1) ~ pop_gen + hab_gen + SA + 
            Original_environment:Test_environment,
          contrasts = list(Original_environment = "contr.sum", 
                           Test_environment = "contr.sum"), 
          data = data_PERF)
  
  
## F test for SA
(Fratio <- (anova(m1)[3,2]/anova(m1)[4,2])/(1/anova(m1)[4, 1]))
(pvalue <- 1 - pf(Fratio, 1, anova(m1)[4, 1])) 
  
  
#######################################################
## Analysis of non-genetic effects lm   ###
#######################################################
  
m2 <- aov(log(Nb_adults+1) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0, 
          data = data_PERF)

## F test for SA
(Fratio_Gen <- (anova(m2)[3,2]/anova(m2)[5,2])/(1/anova(m2)[5, 1]))
(pvalue_Gen <- 1 - pf(Fratio_Gen, 1, anova(m2)[5, 1]) )


## F test for SA
(Fratio_NonGen <- (anova(m2)[4,2]/anova(m2)[6,2])/(1/anova(m2)[6, 1]))
(pvalue_NonGen <- 1 - pf(Fratio_NonGen, 1, anova(m2)[6, 1]) )


## Compute R2 for SA 
## = MS Interaction model without SA - MS Interaction model with SA / MS Interaction model without SA
(r2_SA_genet <- 1-(anova(m2)[5, 3]/((anova(m2)[3, 2]+anova(m2)[5, 2])/(anova(m2)[3, 1]+anova(m2)[5, 1]))))

(r2_SA_nongenet <- 1-(anova(m2)[6, 3]/((anova(m2)[4, 2]+anova(m2)[6, 2])/(anova(m2)[4, 1]+anova(m2)[6, 1]))))

```



## Analysis with eggs as covariable
```{r }

#######################################################
## Should we consider the number of eggs?   ###
#######################################################

# Original
m1 <- aov(log(Nb_adults+1) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0, 
          data = data_PERF)


## Correction for number of eggs
m2 <- aov(log(Nb_adults+1) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0 +
            log(Nb_eggs+1), 
          data = data_PERF)


## With egg score
m3 <- aov(log(Nb_adults+1) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0 +
            EggScore, 
          data = data_PERF)

## Compare with 5 egg scores
m4 <- aov(log(Nb_adults+1) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0 +
            EggScoreFive, 
          data = data_PERF)

## Compare with EggScoreSmall
m5 <- aov(log(Nb_adults+1) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0 +
            EggScoreSmall, 
          data = data_PERF)



MuMIn::model.sel(m1, m2, m3, m4, m5)
# Models are not all fitted to the same data: because 6 tubes without Nb_eggs are missing for m2, m3, m4 and m5


## Cl= The best model is when the number of eggs is considered as a continuous variable
### model m2 provides a better description of the data than model m1 






#######################################################
## Analysis of genetic effects lm   ###
#######################################################
  
m1 <- aov(log(Nb_adults+1) ~ pop_gen + hab_gen + SA + 
            Original_environment:Test_environment + log(Nb_eggs+1),
          contrasts = list(Original_environment = "contr.sum", 
                           Test_environment = "contr.sum"), 
          data = data_PERF)
  
  
## F test for SA
(Fratio <- (anova(m1)[3,2]/anova(m1)[5,2])/(1/anova(m1)[5, 1]))
(pvalue <- 1 - pf(Fratio, 1, anova(m1)[5, 1])) 
  
  
#######################################################
## Analysis of non-genetic effects lm   ###
#######################################################
  
m2 <- aov(log(Nb_adults+1) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0 + 
            log(Nb_eggs+1), 
          data = data_PERF)

## F test for SA
(Fratio_Gen <- (anova(m2)[3,2]/anova(m2)[6,2])/(1/anova(m2)[6, 1]))
(pvalue_Gen <- 1 - pf(Fratio_Gen, 1, anova(m2)[6, 1]) )


## F test for SA
(Fratio_NonGen <- (anova(m2)[5,2]/anova(m2)[7,2])/(1/anova(m2)[7, 1]))
(pvalue_NonGen <- 1 - pf(Fratio_NonGen, 1, anova(m2)[7, 1]) )




## Compute R2 for SA 
## = MS Interaction model without SA - MS Interaction model with SA / MS Interaction model without SA
(r2_SA_genet <- 1-(anova(m2)[6, 3]/((anova(m2)[3, 2]+anova(m2)[6, 2])/(anova(m2)[3, 1]+anova(m2)[6, 1]))))

(r2_SA_nongenet <- 1-(anova(m2)[7, 3]/((anova(m2)[5, 2]+anova(m2)[7, 2])/(anova(m2)[5, 1]+anova(m2)[7, 1]))))
```




##Plot
```{r }

(PLOT_adult_G0 <- plot_RTP_residuals(dataset = data_PERF, trait = "Nb_adults", gen = "G0"))
(PLOT_adult_G2 <- plot_RTP_residuals(dataset = data_PERF, trait = "Nb_adults", gen = "G2"))

(PLOT_GEN_adult_G0 <- plot_Genetic_Nongenetic_residuals(dataset = data_PERF, 
                                                    trait = "Nb_adults", 
                                                    effect = "Non-genetic"))
(PLOT_GEN_adult_G2 <- plot_Genetic_Nongenetic_residuals(dataset = data_PERF, 
                                                    trait = "Nb_adults", 
                                                    effect = "Genetic"))


###PLOT 
(PAIR_BLACK_CHERRY_G2_ADULTS <- plot_PairwisePOP_residuals(dataset = data_PERF, 
                                                           trait = "Nb_adults", gen = "G2", 
                                                           fruit1 = "Cherry", fruit2 = "Blackberry"))

(PAIR_CHERRY_STRAW_G2_ADULTS  <- plot_PairwisePOP_residuals(dataset = data_PERF, 
                                                            trait = "Nb_adults", gen = "G2",
                                                            fruit1 = "Strawberry", fruit2 = "Cherry"))

(PAIR_STRW_BLACK_G2_ADULTS  <- plot_PairwisePOP_residuals(dataset = data_PERF, 
                                                          trait = "Nb_adults", gen = "G2",
                                                          fruit1 = "Blackberry", fruit2 = "Strawberry"))



###PLOT 
(PAIR_BLACK_CHERRY_ADULTS <- plot_PairwisePOP_residuals(dataset = data_PERF, 
                                                        trait = "Nb_adults", 
                                                        gen = "Both", 
                                                        fruit1 = "Cherry", 
                                                        fruit2 = "Blackberry"))

(PAIR_CHERRY_STRAW_ADULTS  <- plot_PairwisePOP_residuals(dataset = data_PERF, 
                                                         trait = "Nb_adults", 
                                                         gen = "Both",
                                                         fruit1 = "Strawberry", 
                                                         fruit2 = "Cherry"))

(PAIR_STRW_BLACK_ADULTS  <- plot_PairwisePOP_residuals(dataset = data_PERF, 
                                                       trait = "Nb_adults", 
                                                       gen = "Both",
                                                       fruit1 = "Blackberry", 
                                                       fruit2 = "Strawberry"))
```





# EGG-TO-ADULT VIABILITY
## Exploration data
```{r }

tapply(data_PERF_Rate$Rate, list(data_PERF_Rate$Original_environment, 
                                 data_PERF_Rate$Test_environment, 
                                 data_PERF_Rate$Generation), mean, na.rm = TRUE)


ggplot2::ggplot(data = data_PERF_Rate[data_PERF_Rate$Generation=="G0",], 
                aes(x = Test_environment, y = Rate, color = Test_environment)) +
  facet_wrap( ~ Population) +
  geom_point() +
  geom_boxplot() +
  theme_LO_sober

ggplot2::ggplot(data = data_PERF_Rate[data_PERF_Rate$Generation=="G2",], 
                aes(x = Test_environment, y = Rate, color = Test_environment)) +
  facet_wrap( ~ Population) +
  geom_point() +
  geom_boxplot() +
  theme_LO_sober

ggplot2::ggplot(data = data_PERF_Rate, 
                aes(x = Rate, fill = Original_environment)) +
  facet_wrap( ~ Generation) +
  geom_histogram(position="identity", alpha=0.5) +
  theme_LO_sober



lattice::xyplot(Rate~Nb_eggs|Original_environment*Test_environment, 
                data=data_PERF_Rate)
lattice::xyplot(Rate~EggScore|Original_environment*Test_environment, 
                data=data_PERF_Rate)
lattice::bwplot(Rate~EggScore|Original_environment*Test_environment, 
                data=data_PERF_Rate)

lattice::bwplot(Rate~EggScoreFive|Original_environment*Test_environment, 
       data=data_PERF_Rate)

lattice::bwplot(Rate~EggScoreSmall|Original_environment*Test_environment, 
       data=data_PERF_Rate)



AvEmergenceRate <- tapply(data_PERF_Rate$Rate, 
                          list(data_PERF_Rate$EggScoreFive,
                              data_PERF_Rate$Original_environment,
                              data_PERF_Rate$Test_environment),mean)
tapply(data_PERF_Rate$Rate, list(data_PERF_Rate$EggScoreFive,
                                 data_PERF_Rate$Original_environment,
                                 data_PERF_Rate$Test_environment), length)


AvEmergenceRate[, , "Blackberry"][, "Cherry"]/AvEmergenceRate[, , "Blackberry"][, "Blackberry"]
AvEmergenceRate[, , "Cherry"][, "Blackberry"]/AvEmergenceRate[, , "Cherry"][, "Cherry"]

AvEmergenceRate[, , "Blackberry"][, "Cherry"]/AvEmergenceRate[, , "Cherry"][, "Cherry"]

```


## Analysis
```{r }

#######################################################
## Analysis of genetic effects lm   ###
#######################################################
  
m1 <- aov(asin(sqrt(Rate)) ~ pop_gen + hab_gen + SA + 
            Original_environment:Test_environment,
          contrasts = list(Original_environment = "contr.sum", 
                           Test_environment = "contr.sum"), 
          data = data_PERF_Rate)
  
  
## F test for SA
(Fratio <- (anova(m1)[3,2]/anova(m1)[4,2])/(1/anova(m1)[4, 1]))
(pvalue <- 1 - pf(Fratio, 1, anova(m1)[4, 1])) 



  
  
#######################################################
## Analysis of non-genetic effects lm   ###
#######################################################
  
m2 <- aov(asin(sqrt(Rate)) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0, 
          data = data_PERF_Rate)

## F test for SA
(Fratio_Gen <- (anova(m2)[3,2]/anova(m2)[5,2])/(1/anova(m2)[5, 1]))
(pvalue_Gen <- 1 - pf(Fratio_Gen, 1, anova(m2)[5, 1]) )


## F test for SA
(Fratio_NonGen <- (anova(m2)[4,2]/anova(m2)[6,2])/(1/anova(m2)[6, 1]))
(pvalue_NonGen <- 1 - pf(Fratio_NonGen, 1, anova(m2)[6, 1]) )


  
  
## Compute R2 for SA 
## = MS Interaction model without SA - MS Interaction model with SA / MS Interaction model without SA
(r2_SA_genet <- 1-(anova(m2)[5, 3]/((anova(m2)[3, 2]+anova(m2)[5, 2])/(anova(m2)[3, 1]+anova(m2)[5, 1]))))

(r2_SA_nongenet <- 1-(anova(m2)[6, 3]/((anova(m2)[4, 2]+anova(m2)[6, 2])/(anova(m2)[4, 1]+anova(m2)[6, 1]))))
```



## Analysis with eggs as covariable
```{r }
#######################################################
## Should we consider the number of eggs?   ###
#######################################################

# Original
m1 <- aov(asin(sqrt(Rate)) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0, 
          data = data_PERF_Rate)



## Correction for number of eggs
m2 <- aov(asin(sqrt(Rate)) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0 +
            log(Nb_eggs), 
          data = data_PERF_Rate)


## With egg score
m3 <- aov(asin(sqrt(Rate)) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0 +
            EggScore, 
          data = data_PERF_Rate)

## Compare with 5 egg scores
m4 <- aov(asin(sqrt(Rate)) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0 +
            EggScoreFive, 
          data = data_PERF_Rate)

## Compare with EggScoreSmall
m5 <- aov(asin(sqrt(Rate)) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0 +
            EggScoreSmall, 
          data = data_PERF_Rate)



MuMIn::model.sel(m1, m2, m3, m4, m5)

## Cl= The best model is when the number of eggs is considered as a continuous variable
### model m2 provides a better description of the data than model m1 







#######################################################
## Analysis of genetic effects lm   ###
#######################################################
  
m1 <- aov(asin(sqrt(Rate)) ~ pop_gen + hab_gen + SA + 
            Original_environment:Test_environment +
            log(Nb_eggs),
          contrasts = list(Original_environment = "contr.sum", 
                           Test_environment = "contr.sum"), 
          data = data_PERF_Rate)
  
  
## F test for SA
(Fratio <- (anova(m1)[3,2]/anova(m1)[5,2])/(1/anova(m1)[5, 1]))
(pvalue <- 1 - pf(Fratio, 1, anova(m1)[5, 1])) 

## Compute R2 = MS Interaction model without SA - MS Interaction model with SA / MS Interaction model without SA
(rsqgen <- 1-anova(m1)[5, 3]/((anova(m1)[3, 2]+anova(m1)[4, 2])/(anova(m1)[3, 1]+anova(m1)[4, 1])))


  
#######################################################
## Analysis of non-genetic effects lm   ###
#######################################################
  
m2 <- aov(asin(sqrt(Rate)) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0 +
            log(Nb_eggs), 
          data = data_PERF_Rate)


## F test for SA
(Fratio_Gen <- (anova(m2)[3,2]/anova(m2)[6,2])/(1/anova(m2)[6, 1]))
(pvalue_Gen <- 1 - pf(Fratio_Gen, 1, anova(m2)[6, 1]) )


## F test for SA
(Fratio_NonGen <- (anova(m2)[5,2]/anova(m2)[7,2])/(1/anova(m2)[7, 1]))
(pvalue_NonGen <- 1 - pf(Fratio_NonGen, 1, anova(m2)[7, 1]) )


# Compute R2 = MS Interaction model without SA - MS Interaction model with SA / MS Interaction model without SA
rsqgen <- 1-anova(m2)[6, 3]/((anova(m2)[3, 2]+anova(m2)[6, 2])/(anova(m2)[3, 1]+anova(m2)[6, 1]))
rsqng <- 1-anova(m2)[7, 3]/((anova(m2)[5, 2]+anova(m2)[7, 2])/(anova(m2)[5, 1]+anova(m2)[7, 1]))
  

## Compute R2 for SA 
## = MS Interaction model without SA - MS Interaction model with SA / MS Interaction model without SA
(r2_SA_genet <- 1-(anova(m2)[6, 3]/((anova(m2)[3, 2]+anova(m2)[6, 2])/(anova(m2)[3, 1]+anova(m2)[6, 1]))))

(r2_SA_nongenet <- 1-(anova(m2)[7, 3]/((anova(m2)[5, 2]+anova(m2)[7, 2])/(anova(m2)[5, 1]+anova(m2)[7, 1]))))



```



##Plot
```{r }

(PLOT_rate_G0 <- plot_RTP_residuals(dataset = data_PERF_Rate, trait = "Rate", gen = "G0"))
(PLOT_rate_G2 <- plot_RTP_residuals(dataset = data_PERF_Rate, trait = "Rate", gen = "G2"))

(PLOT_GEN_rate_G0 <- plot_Genetic_Nongenetic_residuals(dataset = data_PERF_Rate, 
                                                    trait = "Rate", 
                                                    effect = "Non-genetic"))
(PLOT_GEN_rate_G2 <- plot_Genetic_Nongenetic_residuals(dataset = data_PERF_Rate, 
                                                    trait = "Rate", 
                                                    effect = "Genetic"))

```

## Heterogeneity across populations
```{r }
data_Rate_G2 <- data_PERF_Rate[data_PERF_Rate$Generation=="G2",]
data_Rate_G2 <- data_Rate_G2[complete.cases(data_Rate_G2$Rate), ]

  
m0 <- lm(Rate~Original_environment*Test_environment, data=data_Rate_G2,)

summary(m0)

tapply(data_Rate_G2$Rate, 
       list(data_Rate_G2$Original_environment, 
            data_Rate_G2$Test_environment), mean)

tapply(data_Rate_G2$Rate, 
       list(data_Rate_G2$Original_environment, 
            data_Rate_G2$Test_environment), var)

range(data_Rate_G2$Nb_adults, na.rm = TRUE)

## Check number of eggs and adults
tapply(data_Rate_G2$Nb_eggs, 
       list(data_Rate_G2$Original_environment, 
            data_Rate_G2$Test_environment), mean)

tapply(data_Rate_G2$Nb_adults, 
       list(data_Rate_G2$Original_environment, 
            data_Rate_G2$Test_environment), mean)

## Check for the presence of negative correlations
m1 <- lm(asin(sqrt(Rate)) ~ Population + Test_environment,
         data=data_Rate_G2)
data_Rate_G2$resid <- residuals(m1)

meanbypopbytestenv <- as.data.frame(tapply(data_Rate_G2$resid, 
                                           list(data_Rate_G2$Population,
                                                data_Rate_G2$Test_environment), mean))


## Cherry ~ Blackberry
plot(meanbypopbytestenv$Blackberry, 
     meanbypopbytestenv$Cherry, 
     col=as.numeric(data_Rate_G2$Original_environment[match(rownames(meanbypopbytestenv),
                                                    data_Rate_G2$Population)]), 
     xlab="Blackberry", ylab="Cherry", pch=16)
legend("topright", levels(data_Rate_G2$Original_environment), 
       col=as.numeric(as.factor(levels(data_Rate_G2$Original_environment))), pch=16)

## Strawberry ~ Cherry
plot(meanbypopbytestenv$Cherry,  meanbypopbytestenv$Strawberry, col=as.numeric(data_Rate_G2$Original_environment[match(rownames(meanbypopbytestenv), data_Rate_G2$Population)]), xlab="Cherry", ylab="Strawberry", pch=16)
legend("bottomright", levels(data_Rate_G2$Original_environment), col=as.numeric(as.factor(levels(data_Rate_G2$Original_environment))), pch=16)

## Strawberry ~ Blackberry
plot(meanbypopbytestenv$Blackberry, meanbypopbytestenv$Strawberry, col=as.numeric(data_Rate_G2$Original_environment[match(rownames(meanbypopbytestenv), data_Rate_G2$Population)]), xlab="Blackberry", ylab="Strawberry", pch=16)
legend("topright", levels(data_Rate_G2$Original_environment), col=as.numeric(as.factor(levels(data_Rate_G2$Original_environment))), pch=16)


###PLOT 
(PAIR_BLACK_CHERRY_G2_RATE <- plot_PairwisePOP_residuals(dataset = data_PERF_Rate, trait = "Rate", gen = "G2", 
                                       fruit1 = "Cherry", fruit2 = "Blackberry"))

(PAIR_CHERRY_STRAW_G2_RATE <- plot_PairwisePOP_residuals(dataset = data_PERF_Rate, trait = "Rate", gen = "G2", 
                                       fruit1 = "Strawberry", fruit2 = "Cherry"))

(PAIR_STRW_BLACK_G2_RATE <- plot_PairwisePOP_residuals(dataset = data_PERF_Rate, trait = "Rate", gen = "G2", 
                                       fruit1 = "Blackberry", fruit2 = "Strawberry"))


(PAIR_BLACK_CHERRY_RATE <- plot_PairwisePOP_residuals(dataset = data_PERF_Rate, 
                                                      trait = "Rate", 
                                                      gen = "Both", 
                                                      fruit1 = "Cherry", 
                                                      fruit2 = "Blackberry"))

(PAIR_CHERRY_STRAW_RATE <- plot_PairwisePOP_residuals(dataset = data_PERF_Rate, 
                                                      trait = "Rate", 
                                                      gen = "Both", 
                                                      fruit1 = "Strawberry", 
                                                      fruit2 = "Cherry"))

(PAIR_STRW_BLACK_RATE <- plot_PairwisePOP_residuals(dataset = data_PERF_Rate, 
                                                    trait = "Rate", 
                                                    gen = "Both",
                                                    fruit1 = "Blackberry", 
                                                    fruit2 = "Strawberry"))
```


# OVIOSITION PREFERENCE 
## Twelve fruits
### Exploration data
```{r }

tapply(data_PREF$Nb_eggs, list(data_PREF$Original_environment, 
                                 data_PREF$Test_environment, 
                                 data_PREF$Generation), mean, na.rm = TRUE)


ggplot2::ggplot(data = data_PREF, 
                aes(x = Test_environment, y = Nb_eggs, color = Test_environment)) +
  facet_wrap( ~ Population) +
  geom_point() +
  geom_boxplot() +
  theme_LO_sober


ggplot2::ggplot(data = data_PREF, 
                aes(x = Nb_eggs, fill = Original_environment)) +
  facet_wrap( ~ Generation) +
  geom_histogram(position="identity", alpha=0.5) +
  theme_LO_sober


```


### Analysis
```{r }

#######################################################
## Analysis of genetic effects lm   ###
#######################################################
  
m1 <- aov(log(Nb_eggs+1) ~ pop_gen + hab_gen + SA + 
            Original_environment:Test_environment,
          contrasts = list(Original_environment = "contr.sum", 
                           Test_environment = "contr.sum"), 
          data = data_PREF)
  
  
## F test for SA
(Fratio <- (anova(m1)[3,2]/anova(m1)[4,2])/(1/anova(m1)[4, 1]))
(pvalue <- 1 - pf(Fratio, 1, anova(m1)[4, 1])) 
  
  
#######################################################
## Analysis of non-genetic effects lm   ###
#######################################################
  
m2 <- aov(log(Nb_eggs+1) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0 +
            BoxID, 
          data = data_PREF)

## F test for SA
(Fratio_Gen <- (anova(m2)[3,2]/anova(m2)[6,2])/(1/anova(m2)[6, 1]))
(pvalue_Gen <- 1 - pf(Fratio_Gen, 1, anova(m2)[6, 1]) )


## F test for SA
(Fratio_NonGen <- (anova(m2)[5,2]/anova(m2)[7,2])/(1/anova(m2)[7, 1]))
(pvalue_NonGen <- 1 - pf(Fratio_NonGen, 1, anova(m2)[7, 1]) )




## Compute R2 for SA 
## = MS Interaction model without SA - MS Interaction model with SA / MS Interaction model without SA
(r2_SA_genet <- 1-(anova(m2)[6, 3]/((anova(m2)[3, 2]+anova(m2)[6, 2])/(anova(m2)[3, 1]+anova(m2)[6, 1]))))

(r2_SA_nongenet <- 1-(anova(m2)[7, 3]/((anova(m2)[5, 2]+anova(m2)[7, 2])/(anova(m2)[5, 1]+anova(m2)[7, 1]))))




#Local adaptation pattern: 
lm_val = lm(log(Nb_eggs+1) ~ Test_environment + Population + SA + 
                      Test_environment:Original_environment + BoxID, 
                    data = data_PREF[data_PREF$Generation=="G0",])

(Fratio = anova(lm_val)[3,3]/anova(lm_val)[5,3])
(pvalue = 1 - pf(Fratio,anova(lm_val)[3,1],anova(lm_val)[5,1]))
(df1 = anova(lm_val)[3,1])
(df2 = anova(lm_val)[5,1])

lm_val = lm(log(Nb_eggs+1) ~ Test_environment + Population + SA + 
                      Test_environment:Original_environment + BoxID, 
                    data = data_PREF[data_PREF$Generation=="G2",])

(Fratio = anova(lm_val)[3,3]/anova(lm_val)[5,3])
(pvalue = 1 - pf(Fratio,anova(lm_val)[3,1],anova(lm_val)[5,1]))
(df1 = anova(lm_val)[3,1])
(df2 = anova(lm_val)[5,1])

```



## Three fruits
### Exploration data
```{r }

tapply(data_PREF_three$Nb_eggs, list(data_PREF_three$Original_environment, 
                                 data_PREF_three$Test_environment, 
                                 data_PREF_three$Generation), mean, na.rm = TRUE)


ggplot2::ggplot(data = data_PREF_three, 
                aes(x = Test_environment, y = Nb_eggs, color = Test_environment)) +
  facet_wrap( ~ Population) +
  geom_point() +
  geom_boxplot() +
  theme_LO_sober


ggplot2::ggplot(data = data_PREF_three, 
                aes(x = Nb_eggs, fill = Original_environment)) +
  facet_wrap( ~ Generation) +
  geom_histogram(position="identity", alpha=0.5) +
  theme_LO_sober


```


### Analysis
```{r }

#######################################################
## Analysis of genetic effects lm   ###
#######################################################
  
m1 <- aov(log(Nb_eggs+1) ~ pop_gen + hab_gen + SA + 
            Original_environment:Test_environment +
            BoxID,
          contrasts = list(Original_environment = "contr.sum", 
                           Test_environment = "contr.sum"), 
          data = data_PREF_three)
  
  
## F test for SA
(Fratio <- (anova(m1)[3,2]/anova(m1)[5,2])/(1/anova(m1)[5, 1]))
(pvalue <- 1 - pf(Fratio, 1, anova(m1)[5, 1])) 
  
  
#######################################################
## Analysis of non-genetic effects lm   ###
#######################################################
  
m2 <- aov(log(Nb_eggs+1) ~ pop_gen + hab_gen + SA:IndicG0 + SA +
            Original_environment:Test_environment + 
            Original_environment:Test_environment:IndicG0 +
            BoxID, 
          data = data_PREF_three)

## F test for SA
(Fratio_Gen <- (anova(m2)[3,2]/anova(m2)[6,2])/(1/anova(m2)[6, 1]))
(pvalue_Gen <- 1 - pf(Fratio_Gen, 1, anova(m2)[6, 1]) )


## F test for SA
(Fratio_NonGen <- (anova(m2)[5,2]/anova(m2)[7,2])/(1/anova(m2)[7, 1]))
(pvalue_NonGen <- 1 - pf(Fratio_NonGen, 1, anova(m2)[7, 1]) )


## Compute R2 for SA 
# ## = MS Interaction model without SA - MS Interaction model with SA / MS Interaction model without SA
# (r2_SA_genet <- 1-(anova(m2)[6, 3]/((anova(m2)[3, 2]+anova(m2)[6, 2])/(anova(m2)[3, 1]+anova(m2)[6, 1]))))
# 
# (r2_SA_nongenet <- 1-(anova(m2)[7, 3]/((anova(m2)[5, 2]+anova(m2)[7, 2])/(anova(m2)[5, 1]+anova(m2)[7, 1]))))
  ## Compute R2 = MS Interaction model without SA - MS Interaction model with SA / MS Interaction model without SA
rsqgen <- 1-anova(m2)[6, 3]/((anova(m2)[3, 2]+anova(m2)[6, 2])/(anova(m2)[3, 1]+anova(m2)[6, 1]))
rsqng <- 1-anova(m2)[7, 3]/((anova(m2)[5, 2]+anova(m2)[7, 2])/(anova(m2)[5, 1]+anova(m2)[7, 1]))
  rsqgen
  rsqng

```



### Plot
```{r }

(PLOT_pref_G0 <- plot_RTP_residuals(dataset = data_PREF_three, 
                                    trait = "Nb_eggs", gen = "G0"))
(PLOT_pref_G2 <- plot_RTP_residuals(dataset = data_PREF_three, 
                                    trait = "Nb_eggs", gen = "G2"))



(PLOT_GEN_pref_G0 <- plot_Genetic_Nongenetic_residuals(dataset = data_PREF_three, 
                                    trait = "Nb_eggs", effect = "Non-genetic"))
(PLOT_GEN_pref_G2 <- plot_Genetic_Nongenetic_residuals(dataset = data_PREF_three, 
                                    trait = "Nb_eggs", effect = "Genetic"))



###PLOT 
(PAIR_BLACK_CHERRY_G2_PREF <- plot_PairwisePOP_residuals(dataset = data_PREF_three, 
                                                           trait = "Nb_eggs", gen = "G2", 
                                                           fruit1 = "Cherry", fruit2 = "Blackberry"))

(PAIR_CHERRY_STRAW_G2_PREF  <- plot_PairwisePOP_residuals(dataset = data_PREF_three, 
                                                            trait = "Nb_eggs", gen = "G2",
                                                            fruit1 = "Strawberry", fruit2 = "Cherry"))

(PAIR_STRW_BLACK_G2_PREF  <- plot_PairwisePOP_residuals(dataset = data_PREF_three, 
                                                          trait = "Nb_eggs", gen = "G2",
                                                          fruit1 = "Blackberry", fruit2 = "Strawberry"))



###PLOT 
(PAIR_BLACK_CHERRY_PREF <- plot_PairwisePOP_residuals(dataset = data_PREF_three,
                                                      trait = "Nb_eggs", 
                                                      gen = "Both", 
                                                      fruit1 = "Cherry", 
                                                      fruit2 = "Blackberry"))

(PAIR_CHERRY_STRAW_PREF  <- plot_PairwisePOP_residuals(dataset = data_PREF_three, 
                                                       trait = "Nb_eggs", 
                                                       gen = "Both",
                                                       fruit1 = "Strawberry", 
                                                       fruit2 = "Cherry"))

(PAIR_STRW_BLACK_PREF  <- plot_PairwisePOP_residuals(dataset = data_PREF_three, 
                                                     trait = "Nb_eggs", 
                                                     gen = "Both",
                                                     fruit1 = "Blackberry", 
                                                     fruit2 = "Strawberry"))
```





# PLOT LOCAL ADAPTATION
```{r }
legend <- lemon::g_legend(PLOT_pref_G0)

############## FIRST GENERATION 
LOCAL_ADAPTATION_PLOT_FRST <- cowplot::ggdraw() +
  cowplot::draw_plot(PLOT_eggs_G0+theme(legend.position = "none", 
                                        plot.title = element_blank()),
            x =0, y = 0.5, width = 0.36, height = 0.46) +
  cowplot::draw_plot(PLOT_adult_G0+theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.4, y = 0.5, width =0.36, height = 0.46) +
  cowplot::draw_plot(PLOT_rate_G0+theme(legend.position = "none", 
                                        plot.title = element_blank()),
            x =0, y = 0, width = 0.36, height = 0.46) +
  cowplot::draw_plot(PLOT_pref_G0+theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.4, y = 0, width = 0.36, height = 0.46) +
  cowplot::draw_plot(legend, x = 0.85, y = 0.5, width = 0.0001, height = 0.0001) +
  cowplot::draw_plot_label(c("A", "B", "C", "D"), 
                           c(0.01, 0.4,0.01, 0.4), 
                  c(1, 1,0.5,0.5), size = 19)
# + cowplot::draw_plot_label("First generation", x = 0.2, y = 1 , size = 14) 
LOCAL_ADAPTATION_PLOT_FRST


# cowplot::save_plot(file =here::here("figures","Reciprocal_experiment_FirstGeneration.pdf"),
#                   LOCAL_ADAPTATION_PLOT_FRST, base_height = 20/cm(1),
#                   base_width = 30/cm(1), dpi = 1200)


############## THIRD GENERATION 
LOCAL_ADAPTATION_PLOT_THIRD <- cowplot::ggdraw() +
    cowplot::draw_plot(PLOT_eggs_G0+theme(legend.position = "none", 
                                        plot.title = element_blank()),
            x =0, y = 0.5, width = 0.36, height = 0.46) +
  cowplot::draw_plot(PLOT_rate_G0+theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.4, y = 0.5, width =0.36, height = 0.46) +
  cowplot::draw_plot(PLOT_rate_G0+theme(legend.position = "none", 
                                        plot.title = element_blank()),
            x =0, y = 0, width = 0.36, height = 0.46) +
  cowplot::draw_plot(PLOT_pref_G0+theme(legend.position = "none", 
                                        plot.title = element_blank()),
            x =0, y = 0.5, width = 0.36, height = 0.46) +
  cowplot::draw_plot(PLOT_adult_G2+theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.4, y = 0.5, width =0.36, height = 0.46) +
  cowplot::draw_plot(PLOT_rate_G2+theme(legend.position = "none", 
                                        plot.title = element_blank()),
            x =0, y = 0, width = 0.36, height = 0.46) +
  cowplot::draw_plot(PLOT_pref_G2+theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.4, y = 0, width = 0.36, height = 0.46) +
  cowplot::draw_plot(legend, x = 0.85, y = 0.5, width = 0.0001, height = 0.0001) +
  cowplot::draw_plot_label(c("A", "B", "C", "D"), 
                           c(0.01, 0.4,0.01, 0.4), 
                  c(1, 1,0.5,0.5), size = 19)
LOCAL_ADAPTATION_PLOT_THIRD
# 
# 
# cowplot::save_plot(file =here::here("figures","Reciprocal_experiment_ThirdGeneration.pdf"),
#                   LOCAL_ADAPTATION_PLOT_THIRD, base_height = 20/cm(1),
#                   base_width = 30/cm(1), dpi = 1200)
# 



## ALL GENERATIONS 
LOCAL_ADAPTATION_PLOT <- cowplot::ggdraw() + 
  cowplot::draw_plot(PLOT_pref_G0 + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.01, y = 0.5, width = 0.25, height = 0.45) + 
  cowplot::draw_plot(PLOT_eggs_G0 + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.31, y = 0.5, width = 0.25, height = 0.45) + 
  cowplot::draw_plot(PLOT_rate_G0 + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.61, y = 0.5, width = 0.25, height = 0.45) + 
  cowplot::draw_plot(legend, x = 0.93, y = 0.5, width = 0.0001, height = 0.0001) + 
  cowplot::draw_plot(PLOT_pref_G2 + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.01, y = 0, width = 0.25, height = 0.45) + 
  cowplot::draw_plot(PLOT_eggs_G2 + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.31, y = 0, width = 0.25, height = 0.45) + 
  cowplot::draw_plot(PLOT_rate_G2 + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.61, y = 0, width = 0.25, height = 0.45) + 
  cowplot::draw_plot_label(c("Generation: G0", "A", "B", "C", " ",
                    "Generation: G2", "D", "E", "F", " "),  
                  x = c(0.4, 0.01, 0.30, 0.61, 0.92, 0.4, 0.01, 0.3, 0.61, 0.92), 
                  y = c(1, 0.98, 0.98, 0.98, 0.98, 0.5, 0.48, 0.48, 0.48, 0.48), 
                  hjust = c(0,0,0,0,0,0,0,0,0,0), 
                  vjust = c(1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5),
                  size = 16) 
 LOCAL_ADAPTATION_PLOT

 
 cowplot::save_plot(file =here::here("figures", "LOCAL_ADAPTATION_G0_G2.pdf"),
                   LOCAL_ADAPTATION_PLOT,
                   base_height = 18/cm(1), base_width = 34/cm(1), dpi = 610)



```




# PLOT GENETIC vs NON GENETIC
```{r }
legend <- lemon::g_legend(PLOT_pref_G0)

Genetic_NonGenetic_PLOT <- cowplot::ggdraw() + 
  cowplot::draw_plot(PLOT_GEN_pref_G2 + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.01, y = 0.5, width = 0.25, height = 0.45) + 
  cowplot::draw_plot(PLOT_GEN_eggs_G2 + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.31, y = 0.5, width = 0.25, height = 0.45) + 
  cowplot::draw_plot(PLOT_GEN_rate_G2 + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.61, y = 0.5, width = 0.25, height = 0.45) + 
  cowplot::draw_plot(legend, x = 0.93, y = 0.5, width = 0.0001, height = 0.0001) + 
  cowplot::draw_plot(PLOT_GEN_pref_G0 + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.01, y = 0, width = 0.25, height = 0.45) + 
  cowplot::draw_plot(PLOT_GEN_eggs_G0 + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.31, y = 0, width = 0.25, height = 0.45) + 
  cowplot::draw_plot(PLOT_GEN_rate_G0 + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.61, y = 0, width = 0.25, height = 0.45) + 
  cowplot::draw_plot_label(c("Genetic effects", "A", "B", "C", " ",
                    "Non-genetic effects", "D", "E", "F", " "),  
                  x = c(0.4, 0.01, 0.30, 0.61, 0.92, 0.4, 0.01, 0.3, 0.61, 0.92), 
                  y = c(1, 0.98, 0.98, 0.98, 0.98, 0.5, 0.48, 0.48, 0.48, 0.48), 
                  hjust = c(0,0,0,0,0,0,0,0,0,0), 
                  vjust = c(1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5),
                  size = 16) 
 Genetic_NonGenetic_PLOT

 
 cowplot::save_plot(file =here::here("figures", "GENETIC_NONGENETIC_First_Third.pdf"),
                   Genetic_NonGenetic_PLOT,
                   base_height = 18/cm(1), base_width = 34/cm(1), dpi = 610)



```




# PLOT HETEROGENEITY
```{r }

legend <- lemon::g_legend(PAIR_CHERRY_STRAW_G2_PREF)

############## THIRD GENERATION 
HETEROGENEITY_PLOT_THIRD <- cowplot::ggdraw() +
  cowplot::draw_plot(PAIR_BLACK_CHERRY_G2_EGGS+theme(legend.position = "none", 
                                        plot.title = element_blank()),
            x = 0, y = 0.75, width = 0.25, height = 0.25) +
  cowplot::draw_plot(PAIR_CHERRY_STRAW_G2_EGGS+theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.30, y = 0.75, width = 0.25, height = 0.25) +
  cowplot::draw_plot(PAIR_STRW_BLACK_G2_EGGS+theme(legend.position = "none", 
                                        plot.title = element_blank()),
            x = 0.60, y = 0.75, width = 0.25, height = 0.25) +    
  #cowplot::draw_plot(legend, x = 0.85, y = 0.8, width = 0.0001, height = 0.0001) +
  cowplot::draw_plot(PAIR_BLACK_CHERRY_G2_RATE+theme(legend.position = "none", 
                                        plot.title = element_blank()),
            x = 0, y = 0.5, width = 0.25, height = 0.25) +
  cowplot::draw_plot(PAIR_CHERRY_STRAW_G2_RATE+theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.30, y = 0.5, width = 0.25, height = 0.25) +
  cowplot::draw_plot(PAIR_STRW_BLACK_G2_RATE+theme(legend.position = "none", 
                                        plot.title = element_blank()),
            x = 0.60, y = 0.5, width = 0.25, height = 0.25) +    
  cowplot::draw_plot(PAIR_BLACK_CHERRY_G2_ADULTS+theme(legend.position = "none", 
                                        plot.title = element_blank()),
            x = 0, y = 0.25, width = 0.25, height = 0.25) +
  cowplot::draw_plot(PAIR_CHERRY_STRAW_G2_ADULTS+theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.30, y = 0.25, width = 0.25, height = 0.25) +
  cowplot::draw_plot(PAIR_STRW_BLACK_G2_ADULTS+theme(legend.position = "none", 
                                        plot.title = element_blank()),
            x = 0.60, y = 0.25, width = 0.25, height = 0.25) +    
  cowplot::draw_plot(PAIR_BLACK_CHERRY_G2_PREF+theme(legend.position = "none", 
                                        plot.title = element_blank()),
            x = 0, y = 0, width = 0.25, height = 0.25) +
  cowplot::draw_plot(PAIR_CHERRY_STRAW_G2_PREF+theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.30, y = 0, width = 0.25, height = 0.25) +
  cowplot::draw_plot(PAIR_STRW_BLACK_G2_PREF+theme(legend.position = "none", 
                                        plot.title = element_blank()),
            x = 0.60, y = 0, width = 0.25, height = 0.25) +    
  cowplot::draw_plot(legend, x = 0.93, y = 0.5, width = 0.0001, height = 0.0001) 
  HETEROGENEITY_PLOT_THIRD


# cowplot::save_plot(file =here::here("figures","Heterogeneity_Across_Pop_ThirdGeneration.pdf"),
#                   HETEROGENEITY_PLOT_THIRD, base_height = 35/cm(1),
#                   base_width = 35/cm(1), dpi = 1200)
# 


  
legend <- lemon::g_legend(PAIR_CHERRY_STRAW_PREF)

  
############## ALL GENERATION 
HETEROGENEITY_PLOT <- cowplot::ggdraw() +
  cowplot::draw_plot(PAIR_BLACK_CHERRY_PREF+theme(legend.position = "none", 
                                        plot.title = element_blank()),
            x = 0, y = 0.66, width = 0.28, height = 0.28) +
  cowplot::draw_plot(PAIR_CHERRY_STRAW_PREF+theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.30, y = 0.66, width = 0.28, height = 0.28) +
  cowplot::draw_plot(PAIR_STRW_BLACK_PREF+theme(legend.position = "none", 
                                        plot.title = element_blank()),
            x = 0.60, y = 0.66, width = 0.28, height = 0.28) +    
  #cowplot::draw_plot(legend, x = 0.85, y = 0.8, width = 0.0001, height = 0.0001) +
  cowplot::draw_plot(PAIR_BLACK_CHERRY_EGGS+theme(legend.position = "none", 
                                        plot.title = element_blank()),
            x = 0, y = 0.33, width = 0.28, height = 0.28) +
  cowplot::draw_plot(PAIR_CHERRY_STRAW_EGGS+theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.30, y = 0.33, width = 0.28, height = 0.28) +
  cowplot::draw_plot(PAIR_STRW_BLACK_EGGS+theme(legend.position = "none", 
                                        plot.title = element_blank()),
            x = 0.60, y = 0.33, width = 0.28, height = 0.28) +    
  cowplot::draw_plot(PAIR_BLACK_CHERRY_RATE+theme(legend.position = "none", 
                                        plot.title = element_blank()),
            x = 0, y = 0, width = 0.28, height = 0.28) +
  cowplot::draw_plot(PAIR_CHERRY_STRAW_RATE+theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.30, y = 0, width = 0.28, height = 0.28) +
  cowplot::draw_plot(PAIR_STRW_BLACK_RATE+theme(legend.position = "none", 
                                        plot.title = element_blank()),
            x = 0.60, y = 0, width = 0.28, height = 0.28) +    
  cowplot::draw_plot(legend, x = 0.93, y = 0.5, width = 0.0001, height = 0.0001)  + 
  cowplot::draw_plot_label(c("Oviposition preference", 
                             "Oviposition stimulation", 
                             "Emergence rate"),  
                  x = c(0.48,0.48,0.48), 
                  y = c(0.96, 0.63, 0.29), 
                  hjust = c(0.5,0.5,0.5), 
                  vjust = c(0.5,0.5,0.5),
                  size = 16) 
#HETEROGENEITY_PLOT


cowplot::save_plot(file =here::here("figures","Heterogeneity_Across_Pop.pdf"),
                  HETEROGENEITY_PLOT, base_height = 30/cm(1),
                  base_width = 30/cm(1), dpi = 1200)


```








# RELATION BETWEEN TRAITS
```{r }

PLOT_Blackberry <- plot_RelationTraits_residuals(gen = "G2", 
                                                fruit = "Blackberry", 
                                                trait2 = "Preference")
PLOT_Cherry <- plot_RelationTraits_residuals(gen = "G2", 
                                                fruit = "Cherry", 
                                                trait2 = "Preference")
PLOT_Strawberry <- plot_RelationTraits_residuals(gen = "G2", 
                                                fruit = "Strawberry", 
                                                trait2 = "Preference")
PLOT_Blackberry_Stim <- plot_RelationTraits_residuals(gen = "G2", 
                                                fruit = "Blackberry", 
                                                trait2 = "Stimulation")
PLOT_Cherry_Stim <- plot_RelationTraits_residuals(gen = "G2", 
                                                fruit = "Cherry", 
                                                trait2 = "Stimulation")
PLOT_Strawberry_Stim <- plot_RelationTraits_residuals(gen = "G2", 
                                                fruit = "Strawberry", 
                                                trait2 = "Stimulation")



legend <- lemon::g_legend(PLOT_Strawberry_Stim)

RELATION_TRAITS <- cowplot::ggdraw() + 
  cowplot::draw_plot(PLOT_Blackberry_Stim + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.01, y = 0.5, width = 0.25, height = 0.45) + 
  cowplot::draw_plot(PLOT_Cherry_Stim + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.31, y = 0.5, width = 0.25, height = 0.45) + 
  cowplot::draw_plot(PLOT_Strawberry_Stim + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.61, y = 0.5, width = 0.25, height = 0.45) + 
  cowplot::draw_plot(legend, x = 0.93, y = 0.5, width = 0.0001, height = 0.0001) + 
  cowplot::draw_plot(PLOT_Blackberry + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.01, y = 0, width = 0.25, height = 0.45) + 
  cowplot::draw_plot(PLOT_Cherry + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.31, y = 0, width = 0.25, height = 0.45) + 
  cowplot::draw_plot(PLOT_Strawberry + theme(legend.position = "none", 
                                        plot.title = element_blank()), 
            x = 0.61, y = 0, width = 0.25, height = 0.45) + 
  cowplot::draw_plot_label(c(" ", "A", "B", "C", " ",
                    " ", "D", "E", "F", " "),  
                  x = c(0.4, 0.01, 0.30, 0.61, 0.92, 0.4, 0.01, 0.3, 0.61, 0.92), 
                  y = c(1, 0.98, 0.98, 0.98, 0.98, 0.5, 0.48, 0.48, 0.48, 0.48), 
                  hjust = c(0,0,0,0,0,0,0,0,0,0), 
                  vjust = c(1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5, 1.5),
                  size = 16) 
 RELATION_TRAITS


cowplot::save_plot(file =here::here("figures", "RELATION_TRAITS_G2.pdf"),
                  RELATION_TRAITS,
                  base_height = 18/cm(1), base_width = 34/cm(1), dpi = 610)


```

