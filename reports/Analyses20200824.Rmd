---
title: "Analyses"
author: "Nicolas O. Rode"
date: '`r as.character(format(Sys.Date(), format="%d/%m/%Y"))`'
output:
#  rmdformats::readthedown:
#    highlight: kate
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: true
---
Main conclusions:
Statistical power higher for emergence rate than for number of adults
Emergence rate is density dependent with optimum around 100eggs per tube
Variation in the number of eggs between 50 and 100 has more effect in emeergence rates than variation between 150 and 250
The SA model should include the number of eggs as a covariate or a factor wit an egg score to increase power

# Load packages
```{r }
library(lattice)
library(lme4)

```
# Performance
## Load data
```{r }

data <- read.table(file=here::here("data", "DATACOMPLET_PERF.csv"), header=TRUE, sep=",")

head(data)
str(data)
data$Generation

data <- data[data$Generation=="G2",]

#Remove GF and Grape
data <- data[data$Test_environment!="GF",]
data <- data[data$Test_environment!="Grape",]
data$Test_environment <- factor(data$Test_environment)
data$EggScore <- as.factor(ifelse(data$Nb_eggs<51, 1, ifelse(data$Nb_eggs<101, 2, ifelse(data$Nb_eggs<151, 3, 4))))
data$EggScoreFive <- as.factor(ifelse(data$Nb_eggs<51, 1, ifelse(data$Nb_eggs<101, 2, ifelse(data$Nb_eggs<151, 3, ifelse(data$Nb_eggs<201, 4, 5)))))
data$EggScoreSmall <- as.factor(ifelse(data$Nb_eggs<51, 1, ifelse(data$Nb_eggs<76, 2, ifelse(data$Nb_eggs<101, 3, ifelse(data$Nb_eggs<126, 4, ifelse(data$Nb_eggs<151, 5, 6))))))


## Remove WT3
data <- data[data$Population!="WT3",]
data$Original_environment <- factor(data$Original_environment)

## Remove Cherry52 which has a very high mean
#data <- data[data$Population!="Cherry52",]
data$Population <- factor(data$Population)

data$SA <- as.factor(ifelse(data$Original_environment==data$Test_environment, 1, 0))


data$Emergence_Rate <- data$Nb_adults/data$Nb_eggs
head(data)
## Compute emergence rate
data$Emergence_Rate[data$Emergence_Rate>1] <- rep(1, sum(data$Emergence_Rate>1))

```
## Number of eggs
### Explore data
```{r }

histogram(~Nb_eggs|Original_environment*Test_environment, data=data)
tapply(data$Nb_eggs, list(data$Original_environment, data$Test_environment), mean)

```
### Analysis
```{r }

m1 <- lm(log(Nb_eggs+1) ~ Population + Test_environment + SA + Original_environment:Test_environment, data=data[data$Generation=="G2",])
summary(m1)
anova(m1)
  
## F test for SA
(Fratio_int = (anova(m1)[3,2]/anova(m1)[4,2])/(1/anova(m1)[4,1]))
(pvalue_int = 1 - pf(Fratio_int, 1, anova(m1)[4,1])) #the correct test (see equation D7 in Appendix D of the paper)

## Compute R2 = MS Interaction model without SA - MS Interaction model with SA / MS Interaction model without SA
(rsq2 <- 1-anova(m1)[4, 3]/((anova(m1)[3, 2]+anova(m1)[4, 2])/(anova(m1)[3, 1]+anova(m1)[4, 1])))
```
## Number of adults
### Explore data with blue
```{r }

m0 <- lm(Nb_adults~Original_environment*Test_environment, data=data[data$Generation=="G2",])

summary(m0)

tapply(data$Nb_adults[data$Generation=="G2"], list(data$Original_environment[data$Generation=="G2"], data$Test_environment[data$Generation=="G2"]), mean)

tapply(data$Nb_adults[data$Generation=="G2"], list(data$Original_environment[data$Generation=="G2"], data$Test_environment[data$Generation=="G2"]), var)

range(data$Nb_adults)

## Check number of eggs and adults
tapply(data$Nb_eggs[data$Generation=="G2"], list(data$Population[data$Generation=="G2"], data$Test_environment[data$Generation=="G2"]), mean)

tapply(data$Nb_adults[data$Generation=="G2"], list(data$Population[data$Generation=="G2"], data$Test_environment[data$Generation=="G2"]), mean)

## Check for the presence of negative correlations
m1 <- lm(log(Nb_adults+1) ~ Population + Test_environment, data=data[data$Generation=="G2",])
data$resid <- residuals(m1)

meanbypopbytestenv <- as.data.frame(tapply(data$resid[data$Generation=="G2"], list(data$Population[data$Generation=="G2"], data$Test_environment[data$Generation=="G2"]), mean))


## Cherry ~ Blackberry
plot(meanbypopbytestenv$Blackberry, meanbypopbytestenv$Cherry, col=as.numeric(data$Original_environment[match(rownames(meanbypopbytestenv), data$Population)]), xlab="Blackberry", ylab="Cherry", pch=16)
legend("topright", levels(data$Original_environment), col=as.numeric(as.factor(levels(data$Original_environment))), pch=16)

## Strawberry ~ Cherry
plot(meanbypopbytestenv$Cherry, meanbypopbytestenv$Strawberry, col=as.numeric(data$Original_environment[match(rownames(meanbypopbytestenv), data$Population)]), xlab="Cherry", ylab="Strawberry", pch=16)
legend("topright", levels(data$Original_environment), col=as.numeric(as.factor(levels(data$Original_environment))), pch=16)

## Strawberry ~ Blackberry
plot(meanbypopbytestenv$Blackberry~ meanbypopbytestenv$Strawberry, col=as.numeric(data$Original_environment[match(rownames(meanbypopbytestenv), data$Population)]), xlab="Blackberry", ylab="Strawberry", pch=16)
legend("topright", levels(data$Original_environment), col=as.numeric(as.factor(levels(data$Original_environment))), pch=16)


```

### Explore data with BLUPS
```{r }

m0 <- lmer(log(Nb_adults+1)~ Population + Test_environment + (0 + Test_environment | Population), data = data[data$Generation=="G2",])

## Correlation between fixed effects
plot(coef(m1), fixef(m0))

summary(m0)

BLUP <- ranef(m0)$Population

pairs(BLUP)
## Negative correlation between blups and blues, very weird, no?
plot(BLUP$Test_environmentBlackberry, meanbypopbytestenv$Blackberry, col=as.numeric(data$Original_environment[match(rownames(meanbypopbytestenv), data$Population)]), pch=16)
legend("topright", levels(data$Original_environment), col=as.numeric(as.factor(levels(data$Original_environment))), pch=16)

## Positive correlation betwen blups and blues, as expected
plot(BLUP$Test_environmentCherry, meanbypopbytestenv$Cherry, col=as.numeric(data$Original_environment[match(rownames(meanbypopbytestenv), data$Population)]), pch=16)
legend("topleft", levels(data$Original_environment), col=as.numeric(as.factor(levels(data$Original_environment))), pch=16)

## Positive correlation betwen blups and blues, as expected
plot(BLUP$Test_environmentStrawberry, meanbypopbytestenv$Strawberry, col=as.numeric(data$Original_environment[match(rownames(meanbypopbytestenv), data$Population)]), pch=16)
legend("topright", levels(data$Original_environment), col=as.numeric(as.factor(levels(data$Original_environment))), pch=16)


```

### Analysis
```{r }
## Null model
m0 <- lm(log(Nb_adults+1) ~ Population + Test_environment + Original_environment:Test_environment, data=data[data$Generation=="G2",])

## SA model
m1 <- lm(log(Nb_adults+1) ~ Population + Test_environment + SA + Original_environment:Test_environment, data=data[data$Generation=="G2",])
summary(m1)
anova(m1)
  
## F test for SA
(Fratio_int = (anova(m1)[3,2]/anova(m1)[4,2])/(1/anova(m1)[4,1]))
(pvalue_int = 1 - pf(Fratio_int, 1, anova(m1)[4,1])) #the correct test (see equation D7 in Appendix D of the paper)

## Compute R2 = MS Interaction model without SA - MS Interaction model with SA / MS Interaction model without SA
## rsquare with two models
rsq2 <- (anova(m0)[3, 3]-anova(m1)[4, 3])/anova(m0)[3, 3]
## rsquare with single model
(rsq2 <- 1-anova(m1)[4, 3]/((anova(m1)[3, 2]+anova(m1)[4, 2])/(anova(m1)[3, 1]+anova(m1)[4, 1])))
```

### Power Analysis
```{r, eval=FALSE }

m2 <- lm(log(Nb_adults+1) ~ -1 + Population + Test_environment + Original_environment:Test_environment, data=data[data$Generation=="G2",])
coef(m2)

simdata <- function(seed=1, nrep = 2, npop = 3, SAincrease=0){
  set.seed(seed)
  ## Sample populations
  PopBlackberry <- sort(sample(levels(data$Population)[grep("Blackberry", levels(data$Population))], size=npop, replace = TRUE))
  PopCherry <- sort(sample(levels(data$Population)[grep("Cherry", levels(data$Population))], size=npop, replace = TRUE))
  PopStrawberry <- sort(sample(levels(data$Population)[grep("Strawberry", levels(data$Population))], size=npop, replace = TRUE))
  
  ## Create dataset
  newdata <- expand.grid(Pop_new_name=1:(3*npop), Test_environment=levels(data$Test_environment), Rep=1:nrep)
  newdata$Original_environment <- rep(c("Blackberry", "Cherry", "Strawberry"), each=npop)
  
  ## Add original names to get the right coef in the model
  newdata$Pop_new_name <- as.factor(newdata$Pop_new_name)
  newdata$Population <- newdata$Pop_new_name
  levels(newdata$Population) <- c(PopBlackberry, PopCherry, PopStrawberry)
  
  ## Get design matrix
  mat <- model.matrix(~-1 + Population + Test_environment + Original_environment:Test_environment, data=newdata)
  
  ## Check that the order of the coefficients is the same
  data.frame(colnames(mat), names(coef(m2))[names(coef(m2))%in%colnames(mat)])
  
  coefsim <- coef(m2)[names(coef(m2))%in%colnames(mat)]
  coefsim <- ifelse(is.na(coefsim), 0, coefsim)
  
  ## Increase fitness in sympatric environment
  coefsim[grepl("PopulationBlackberry|Test_environmentCherry:Original_environmentCherry|Test_environmentStrawberry:Original_environmentStrawberry", names(coefsim))] <- coefsim[grepl("PopulationBlackberry|Test_environmentCherry:Original_environmentCherry|Test_environmentStrawberry:Original_environmentStrawberry", names(coefsim))]+SAincrease
  
  newdata$resp <- mat%*%coefsim + rnorm(n=nrow(newdata), mean = 0, sd = sigma(m2))
  
  m3 <- lm(resp ~ -1+Population + Test_environment + Original_environment:Test_environment, data=newdata)
  data.frame(coefsim, coef(m3))
  
  newdata$SA <- as.factor(ifelse(newdata$Original_environment==newdata$Test_environment, 1, 0))
  
  m4 <- lm(resp ~ Pop_new_name + Test_environment + SA + Original_environment:Test_environment, data=newdata)
  summary(m4)
  anova(m4)
    
  ## F test for SA
  (Fratio_int = (anova(m4)[3,2]/anova(m4)[4,2])/(1/anova(m4)[4,1]))
  (pvalue_int = 1 - pf(Fratio_int, 1, anova(m4)[4,1])) #the correct test (see equation D7 in Appendix D of the paper)
  ## rsquare with single model
  (rsq2 <- 1-anova(m4)[4, 3]/((anova(m4)[3, 2]+anova(m4)[4, 2])/(anova(m4)[3, 1]+anova(m4)[4, 1])))
  #print(rsq2)
  return(pvalue_int)
}

simdata(seed=2, nrep = 30, npop = 3)
simdata(seed=2, nrep = 30, npop = 3)

simpval <- sapply(1:500, simdata, nrep = 10, npop = 3)
mean(simpval)
## Compute power
mean(simpval<0.05)
hist(simpval)

simpval10rep <- sapply(1:500, simdata, nrep = 10, npop = 3)
simpval15rep <- sapply(1:500, simdata, nrep = 15, npop = 3)
simpval20rep <- sapply(1:500, simdata, nrep = 20, npop = 3)
simpval25rep <- sapply(1:500, simdata, nrep = 25, npop = 3)
simpval30rep <- sapply(1:500, simdata, nrep = 30, npop = 3)
simpval35rep <- sapply(1:500, simdata, nrep = 35, npop = 3)
simpval40rep <- sapply(1:500, simdata, nrep = 40, npop = 3)
simpval50rep <- sapply(1:500, simdata, nrep = 50, npop = 3)
simpval60rep <- sapply(1:500, simdata, nrep = 60, npop = 3)
simpval80rep <- sapply(1:500, simdata, nrep = 80, npop = 3)
simpval100rep <- sapply(1:500, simdata, nrep = 100, npop = 3)

## Compute power
val <- data.frame(simpval10rep, simpval15rep, simpval20rep, simpval25rep, simpval30rep, simpval35rep, simpval40rep, simpval50rep, simpval60rep, simpval80rep, simpval100rep)

computepower <- function(x){
  return(mean(x<0.05))
}

statpower <- apply(val, 2, computepower)

plot(c(10, 15, 20, 25, 30, 35, 40, 50, 60, 80, 100), statpower, las=1, xlab="Number of replicates", ylab="Statistical Power")

```

## Number of adults~ Number of eggs
### Explore data
```{r }

AvNb_adults <- tapply(data$Nb_adults, list(data$EggScoreFive, data$Original_environment, data$Test_environment), mean)

AvNb_adults[, , "Blackberry"][, "Cherry"]/AvNb_adults[, , "Blackberry"][, "Blackberry"]

AvNb_adults[, , "Cherry"][, "Blackberry"]/AvNb_adults[, , "Cherry"][, "Cherry"]


xyplot(Nb_adults~Nb_eggs|Original_environment*Test_environment, data=data)

m0 <- lm(log(Nb_adults+1)~log(Nb_eggs+1)+Test_environment+Original_environment, data=data)
m1 <- lm(log(Nb_adults+1)~log(Nb_eggs+1)*Test_environment+Original_environment, data=data)
m2 <- lm(log(Nb_adults+1)~log(Nb_eggs+1)*Original_environment+Test_environment, data=data)

m3 <- lm(log(Nb_adults+1)~Nb_eggs+Test_environment+Original_environment, data=data)

summary(m1)

##Cl: density dependent larval survival rate does not seem to depend on the environment
anova(m1)
anova(m2)

library(MuMIn)
model.sel(m0, m1, m2, m3)

```
### Analysis
```{r }


m1 <- lm(log(Nb_adults+1) ~ Population + Test_environment + SA + Original_environment:Test_environment+log(Nb_eggs+1), data=data[data$Generation=="G2",])
summary(m1)
anova(m1)
  
## F test for SA
(Fratio_int = (anova(m1)[3,2]/anova(m1)[5,2])/(1/anova(m1)[5,1]))
(pvalue_int = 1 - pf(Fratio_int, 1, anova(m1)[5,1])) #the correct test (see equation D7 in Appendix D of the paper)

## Compute R2 = MS Interaction model without SA - MS Interaction model with SA / MS Interaction model without SA
(rsq2 <- 1-anova(m1)[5, 3]/((anova(m1)[3, 2]+anova(m1)[5, 2])/(anova(m1)[3, 1]+anova(m1)[5, 1])))


m2 <- lm(log(Nb_adults+1) ~ Population + Test_environment + SA + Original_environment:Test_environment+EggScore, data=data[data$Generation=="G2",])
summary(m2)
anova(m2)

## F test for SA
(Fratio_int = (anova(m2)[3,2]/anova(m2)[5,2])/(1/anova(m2)[5,1]))
(pvalue_int = 1 - pf(Fratio_int, 1, anova(m2)[5,1])) #the correct test (see equation D7 in Appendix D of the paper)

## Compute R2 = MS Interaction model without SA - MS Interaction model with SA / MS Interaction model without SA
(rsq2 <- 1-anova(m2)[5, 3]/((anova(m2)[3, 2]+anova(m2)[5, 2])/(anova(m2)[3, 1]+anova(m2)[5, 1])))

## Compare with EggScoreFive
m3 <- lm(log(Nb_adults+1) ~ Population + Test_environment + SA + Original_environment:Test_environment+EggScoreFive, data=data[data$Generation=="G2",])

## Compare with EggScoreSmall
m4 <- lm(log(Nb_adults+1) ~ Population + Test_environment + SA + Original_environment:Test_environment+EggScoreSmall, data=data[data$Generation=="G2",])

## No egg information
m0 <- lm(log(Nb_adults+1) ~ Population + Test_environment + SA + Original_environment:Test_environment, data=data[data$Generation=="G2",])

model.sel(m0, m1, m2, m3, m4)

```

### Power Analysis
```{r, eval=FALSE  }

m2 <- lm(log(Nb_adults+1) ~ -1 + Population + Test_environment + Original_environment:Test_environment+EggScore, data=data[data$Generation=="G2",])
coef(m2)

simdata <- function(seed=1, nrep = 2, npop = 3, SAincrease=0){
  set.seed(seed)
  ## Sample populations
  PopBlackberry <- sort(sample(levels(data$Population)[grep("Blackberry", levels(data$Population))], size=npop, replace = TRUE))
  PopCherry <- sort(sample(levels(data$Population)[grep("Cherry", levels(data$Population))], size=npop, replace = TRUE))
  PopStrawberry <- sort(sample(levels(data$Population)[grep("Strawberry", levels(data$Population))], size=npop, replace = TRUE))
  
  ## Create dataset
  newdata <- expand.grid(Pop_new_name=1:(3*npop), Test_environment=levels(data$Test_environment), EggScore=factor(1:4), Rep=1:nrep)
  newdata$Original_environment <- rep(c("Blackberry", "Cherry", "Strawberry"), each=npop)
  
  ## Add original names to get the right coef in the model
  newdata$Pop_new_name <- as.factor(newdata$Pop_new_name)
  newdata$Population <- newdata$Pop_new_name
  levels(newdata$Population) <- c(PopBlackberry, PopCherry, PopStrawberry)
  
  ## Get design matrix
  mat <- model.matrix(~-1 + Population + Test_environment + Original_environment:Test_environment+EggScore, data=newdata)
  
  ## Check that the order of the coefficients is the same
  data.frame(colnames(mat), names(coef(m2))[names(coef(m2))%in%colnames(mat)])
  
  coefsim <- coef(m2)[names(coef(m2))%in%colnames(mat)]
  coefsim <- ifelse(is.na(coefsim), 0, coefsim)
  
  ## Increase fitness in sympatric environment
  coefsim[grepl("PopulationBlackberry|Test_environmentCherry:Original_environmentCherry|Test_environmentStrawberry:Original_environmentStrawberry", names(coefsim))] <- coefsim[grepl("PopulationBlackberry|Test_environmentCherry:Original_environmentCherry|Test_environmentStrawberry:Original_environmentStrawberry", names(coefsim))]+SAincrease
  
  newdata$resp <- mat%*%coefsim + rnorm(n=nrow(newdata), mean = 0, sd = sigma(m2))
  
  m3 <- lm(resp ~ -1+Population + Test_environment + Original_environment:Test_environment+EggScore, data=newdata)
  data.frame(coefsim, coef(m3))
  
  newdata$SA <- as.factor(ifelse(newdata$Original_environment==newdata$Test_environment, 1, 0))
  
  m4 <- lm(resp ~ Pop_new_name + Test_environment + SA + Original_environment:Test_environment+EggScore, data=newdata)
  summary(m4)
  anova(m4)
    
  ## F test for SA
  (Fratio_int = (anova(m4)[3,2]/anova(m4)[5,2])/(1/anova(m4)[5,1]))
  (pvalue_int = 1 - pf(Fratio_int, 1, anova(m4)[5,1])) #the correct test (see equation D7 in Appendix D of the paper)
  ## rsquare with single model
  (rsq2 <- 1-anova(m4)[5, 3]/((anova(m4)[3, 2]+anova(m4)[5, 2])/(anova(m4)[3, 1]+anova(m4)[5, 1])))
  #print(rsq2)
  return(pvalue_int)
}

simdata(seed=2, nrep = 30, npop = 3)

simpval <- sapply(1:500, simdata, nrep = 10, npop = 3)
mean(simpval)
## Compute power
mean(simpval<0.05)
hist(simpval)

simpval10rep <- sapply(1:500, simdata, nrep = 10, npop = 3)
simpval15rep <- sapply(1:500, simdata, nrep = 15, npop = 3)
simpval20rep <- sapply(1:500, simdata, nrep = 20, npop = 3)
simpval25rep <- sapply(1:500, simdata, nrep = 25, npop = 3)
simpval30rep <- sapply(1:500, simdata, nrep = 30, npop = 3)
simpval35rep <- sapply(1:500, simdata, nrep = 35, npop = 3)
simpval40rep <- sapply(1:500, simdata, nrep = 40, npop = 3)
simpval50rep <- sapply(1:500, simdata, nrep = 50, npop = 3)
simpval60rep <- sapply(1:500, simdata, nrep = 60, npop = 3)
simpval80rep <- sapply(1:500, simdata, nrep = 80, npop = 3)
simpval100rep <- sapply(1:500, simdata, nrep = 100, npop = 3)

## Compute power
val <- data.frame(simpval10rep, simpval15rep, simpval20rep, simpval25rep, simpval30rep, simpval35rep, simpval40rep, simpval50rep, simpval60rep, simpval80rep, simpval100rep)

computepower <- function(x){
  return(mean(x<0.05))
}

statpower <- apply(val, 2, computepower)

plot(c(10, 15, 20, 25, 30, 35, 40, 50, 60, 80, 100), statpower, las=1, xlab="Number of replicates", ylab="Statistical Power")

```

## Emergence rate
### Explore data 
```{r }
library(lattice)
xyplot(Emergence_Rate~Nb_eggs|Original_environment*Test_environment, data=data)
xyplot(Emergence_Rate~EggScore|Original_environment*Test_environment, data=data)
bwplot(Emergence_Rate~EggScore|Original_environment*Test_environment, data=data)

bwplot(Emergence_Rate~EggScoreFive|Original_environment*Test_environment, data=data)

bwplot(Emergence_Rate~EggScoreSmall|Original_environment*Test_environment, data=data)



AvEmergenceRate <- tapply(data$Emergence_Rate, list(data$EggScoreFive, data$Original_environment, data$Test_environment), mean)
tapply(data$Emergence_Rate, list(data$EggScoreFive, data$Original_environment, data$Test_environment), length)

AvEmergenceRate[, , "Blackberry"][, "Cherry"]/AvEmergenceRate[, , "Blackberry"][, "Blackberry"]
AvEmergenceRate[, , "Cherry"][, "Blackberry"]/AvEmergenceRate[, , "Cherry"][, "Cherry"]

AvEmergenceRate[, , "Blackberry"][, "Cherry"]/AvEmergenceRate[, , "Cherry"][, "Cherry"]

```
### ANR analysis
```{r }

dataG2 <- data[data$Generation=="G2",]

m0 <- lm(asin(sqrt(Emergence_Rate)) ~ Population + Test_environment, data=dataG2)

dataG2$res <- residuals(m0)

m0 <- lm(res ~ -1 + Original_environment : Test_environment, data=dataG2)

summary(m0)

m0 <- lm(asin(sqrt(Emergence_Rate)) ~ -1+ Population + Test_environment + Original_environment : Test_environment, data=dataG2)
summary(m0)

emmeans::emmeans(m0, list(pairwise ~ Original_environment:Test_environment), adjust = "tukey") #


dataG2$Nb_adults_corr <- dataG2$Nb_adults
dataG2$Nb_adults_corr[dataG2$Nb_adults>dataG2$Nb_eggs] <- dataG2$Nb_eggs[dataG2$Nb_adults>dataG2$Nb_eggs] 

m0 <- glm(cbind(Nb_adults_corr, Nb_eggs-Nb_adults_corr) ~ -1+ Population + Test_environment, family=binomial, data=dataG2)

hist(residuals(m0))

m0 <- lm(residuals(m0) ~ -1 + Original_environment : Test_environment, data=dataG2)
summary(m0)

emmeans::emmeans(m0, list(pairwise ~ Original_environment:Test_environment), adjust = "tukey") #




```
### Explore data with blue
```{r }

m0 <- lm(Emergence_Rate~Original_environment*Test_environment, data=data[data$Generation=="G2",])

summary(m0)

tapply(data$Emergence_Rate[data$Generation=="G2"], list(data$Original_environment[data$Generation=="G2"], data$Test_environment[data$Generation=="G2"]), mean)

tapply(data$Emergence_Rate[data$Generation=="G2"], list(data$Original_environment[data$Generation=="G2"], data$Test_environment[data$Generation=="G2"]), var)

range(data$Nb_adults)

## Check number of eggs and adults
tapply(data$Nb_eggs[data$Generation=="G2"], list(data$Population[data$Generation=="G2"], data$Test_environment[data$Generation=="G2"]), mean)

tapply(data$Nb_adults[data$Generation=="G2"], list(data$Population[data$Generation=="G2"], data$Test_environment[data$Generation=="G2"]), mean)

## Check for the presence of negative correlations
m1 <- lm(asin(sqrt(Emergence_Rate)) ~ Population + Test_environment, data=data[data$Generation=="G2",])
data$resid <- residuals(m1)

meanbypopbytestenv <- as.data.frame(tapply(data$resid[data$Generation=="G2"], list(data$Population[data$Generation=="G2"], data$Test_environment[data$Generation=="G2"]), mean))


## Cherry ~ Blackberry
plot(meanbypopbytestenv$Blackberry, meanbypopbytestenv$Cherry, col=as.numeric(data$Original_environment[match(rownames(meanbypopbytestenv), data$Population)]), xlab="Blackberry", ylab="Cherry", pch=16)
legend("topright", levels(data$Original_environment), col=as.numeric(as.factor(levels(data$Original_environment))), pch=16)

## Strawberry ~ Cherry
plot(meanbypopbytestenv$Cherry, meanbypopbytestenv$Strawberry, col=as.numeric(data$Original_environment[match(rownames(meanbypopbytestenv), data$Population)]), xlab="Cherry", ylab="Strawberry", pch=16)
legend("bottomright", levels(data$Original_environment), col=as.numeric(as.factor(levels(data$Original_environment))), pch=16)

## Strawberry ~ Blackberry
plot(meanbypopbytestenv$Blackberry~ meanbypopbytestenv$Strawberry, col=as.numeric(data$Original_environment[match(rownames(meanbypopbytestenv), data$Population)]), xlab="Blackberry", ylab="Strawberry", pch=16)
legend("topright", levels(data$Original_environment), col=as.numeric(as.factor(levels(data$Original_environment))), pch=16)


```

### Explore data with BLUPS
```{r }

m0 <- lmer(asin(sqrt(Emergence_Rate))~ Population + Test_environment + (0 + Test_environment | Population), data = data[data$Generation=="G2",])

## Correlation between fixed effects
plot(coef(m1), fixef(m0))

summary(m0)

BLUP <- ranef(m0)$Population

pairs(BLUP)

## Positive correlation betwen blups and blues, as expected
plot(BLUP$Test_environmentBlackberry, meanbypopbytestenv$Blackberry, col=as.numeric(data$Original_environment[match(rownames(meanbypopbytestenv), data$Population)]), pch=16)
legend("topleft", levels(data$Original_environment), col=as.numeric(as.factor(levels(data$Original_environment))), pch=16)

## Positive correlation betwen blups and blues, as expected
plot(BLUP$Test_environmentCherry, meanbypopbytestenv$Cherry, col=as.numeric(data$Original_environment[match(rownames(meanbypopbytestenv), data$Population)]), pch=16)
legend("topleft", levels(data$Original_environment), col=as.numeric(as.factor(levels(data$Original_environment))), pch=16)

## Positive correlation betwen blups and blues, as expected
plot(BLUP$Test_environmentStrawberry, meanbypopbytestenv$Strawberry, col=as.numeric(data$Original_environment[match(rownames(meanbypopbytestenv), data$Population)]), pch=16)
legend("bottomright", levels(data$Original_environment), col=as.numeric(as.factor(levels(data$Original_environment))), pch=16)


```

### Analysis
```{r }
data$SA <- as.factor(ifelse(data$Original_environment==data$Test_environment, 1, 0))

m1 <- lm(asin(sqrt(Emergence_Rate)) ~ Population + Test_environment + SA + Original_environment:Test_environment, data=data[data$Generation=="G2",])
summary(m1)
anova(m1)
  
## F test for SA
(Fratio_int = (anova(m1)[3,2]/anova(m1)[4,2])/(1/anova(m1)[4,1]))
(pvalue_int = 1 - pf(Fratio_int, 1, anova(m1)[4,1])) #the correct test (see equation D7 in Appendix D of the paper)

## Compute Rsquare
(rsq2 <- 1-anova(m1)[4, 3]/((anova(m1)[3, 2]+anova(m1)[4, 2])/(anova(m1)[3, 1]+anova(m1)[4, 1])))

## Correct for number of eggs
m2 <- lm(asin(sqrt(Emergence_Rate)) ~ Population + Test_environment + SA + Original_environment:Test_environment+log(Nb_eggs+1), data=data[data$Generation=="G2",])

## F test for SA
(Fratio_int = (anova(m2)[3,2]/anova(m2)[5,2])/(1/anova(m2)[5,1]))
(pvalue_int = 1 - pf(Fratio_int, 1, anova(m2)[5,1])) #the correct test (see equation D7 in Appendix D of the paper)

## Compute Rsquare
(rsq2 <- 1-anova(m2)[5, 3]/((anova(m2)[3, 2]+anova(m2)[5, 2])/(anova(m2)[3, 1]+anova(m2)[5, 1])))

m3 <- lm(asin(sqrt(Emergence_Rate)) ~ Population + Test_environment + SA + Original_environment:Test_environment+EggScore, data=data[data$Generation=="G2",])
summary(m3)
## F test for SA
(Fratio_int = (anova(m3)[3,2]/anova(m3)[5,2])/(1/anova(m3)[5,1]))
(pvalue_int = 1 - pf(Fratio_int, 1, anova(m3)[5,1])) #the correct test (see equation D7 in Appendix D of the paper)

## Compute Rsquare
(rsq2 <- 1-anova(m2)[5, 3]/((anova(m2)[3, 2]+anova(m2)[5, 2])/(anova(m2)[3, 1]+anova(m2)[5, 1])))

## Compare with 5 egg scores
m4 <- lm(asin(sqrt(Emergence_Rate)) ~ Population + Test_environment + SA + Original_environment:Test_environment+EggScoreFive, data=data[data$Generation=="G2",])

## Compare with EggScoreSmall
m5 <- lm(asin(sqrt(Emergence_Rate)) ~ Population + Test_environment + SA + Original_environment:Test_environment+EggScoreSmall, data=data[data$Generation=="G2",])


summary(m4)
model.sel(m1, m2, m3, m4, m5)

## Cl= model m5 provides a better description of the data than model m4 (variation in the number of eggs between 50 and 100 is more important than between 150 and 250)
```

### Power Analysis
```{r , eval=FALSE }

m2 <- lm(asin(sqrt(Emergence_Rate)) ~ -1 + Population + Test_environment + Original_environment:Test_environment, data=data[data$Generation=="G2",])

simdata <- function(seed=1, nrep = 2, npop = 3, varres=0){
  #print(seed)
  set.seed(seed)
  ## Sample populations
  PopBlackberry <- sort(sample(levels(data$Population)[grep("Blackberry", levels(data$Population))], size=npop, replace = TRUE))
  PopCherry <- sort(sample(levels(data$Population)[grep("Cherry", levels(data$Population))], size=npop, replace = TRUE))
  PopStrawberry <- sort(sample(levels(data$Population)[grep("Strawberry", levels(data$Population))], size=npop, replace = TRUE))
  
  ## Create dataset
  newdata <- expand.grid(Pop_new_name=1:(3*npop), Test_environment=levels(data$Test_environment), Rep=1:nrep)
  newdata$Original_environment <- rep(c("Blackberry", "Cherry", "Strawberry"), each=npop)
  
  ## Add original names to get the right coef in the model
  newdata$Pop_new_name <- as.factor(newdata$Pop_new_name)
  newdata$Population <- newdata$Pop_new_name
  levels(newdata$Population) <- c(PopBlackberry, PopCherry, PopStrawberry)
  
  ## Get design matrix
  mat <- model.matrix(~-1 + Population + Test_environment + Original_environment:Test_environment, data=newdata)
  
  ## Check that the order of the coefficients is the same
  data.frame(colnames(mat), names(coef(m2))[names(coef(m2))%in%colnames(mat)])
  
  coefsim <- coef(m2)[names(coef(m2))%in%colnames(mat)]
  coefsim <- ifelse(is.na(coefsim), 0, coefsim)
  newdata$resp <- mat%*%coefsim + rnorm(n=nrow(newdata), mean = 0, sd = varres)
  
  m3 <- lm(resp ~ -1 + Population + Test_environment + Original_environment:Test_environment, data=newdata)

  data.frame(coefsim, coef(m3))
  
  newdata$SA <- as.factor(ifelse(newdata$Original_environment==newdata$Test_environment, 1, 0))
  
  m4 <- lm(resp ~ Pop_new_name + Test_environment + SA + Original_environment:Test_environment, data=newdata)
  summary(m4)
  anova(m4)
    
  ## F test for SA
  (Fratio_int = (anova(m4)[3,2]/anova(m4)[4,2])/(1/anova(m4)[4,1]))
  (pvalue_int = 1 - pf(Fratio_int, 1, anova(m4)[4,1])) #the correct test (see equation D7 in Appendix D of the paper)
  return(pvalue_int)
}

## With 6 populations per fruit
simdata(seed=2, nrep = 30, npop = 6)
simpval <- sapply(1:500, simdata, nrep = 10, npop = 6, varres=sigma(m2))
mean(simpval)
hist(simpval)
## Compute power
mean(simpval<0.05)

simpval10rep <- sapply(1:500, simdata, nrep = 10, npop = 3, varres=sigma(m2))
simpval20rep <- sapply(1:500, simdata, nrep = 20, npop = 3, varres=sigma(m2))
simpval25rep <- sapply(1:500, simdata, nrep = 25, npop = 3, varres=sigma(m2))
simpval30rep <- sapply(1:500, simdata, nrep = 30, npop = 3, varres=sigma(m2))
simpval35rep <- sapply(1:500, simdata, nrep = 35, npop = 3, varres=sigma(m2))
simpval40rep <- sapply(1:500, simdata, nrep = 40, npop = 3, varres=sigma(m2))
simpval60rep <- sapply(1:500, simdata, nrep = 60, npop = 3, varres=sigma(m2))
simpval80rep <- sapply(1:500, simdata, nrep = 80, npop = 3, varres=sigma(m2))
simpval100rep <- sapply(1:500, simdata, nrep = 100, npop = 3, varres=sigma(m2))

## Compute power
val <- data.frame(simpval10rep, simpval20rep, simpval25rep, simpval30rep, simpval35rep, simpval40rep, simpval60rep, simpval80rep, simpval100rep)

computepower <- function(x){
  return(mean(x<0.05))
}

statpower <- apply(val, 2, computepower)

plot(c(10, 20, 25, 30, 35, 40, 60, 80, 100), statpower, las=1, xlab="Number of replicates", ylab="Statistical Power")

```

# Preference
## Load data
```{r }
setwd("/Users/rodenico/Documents/Pro/Articles/2021_NGS_EvolExp/Simulations")

data <- read.table("DATACOMPLET_PREF_POPNAT2018.csv", header=TRUE, sep=";")
head(data)
data <- data[data$Generation=="G2",]

#Remove GF
data <- data[data$Test_environment!="GF",]

data$Test_environment <- factor(data$Test_environment)

## Remove WT3
data <- data[data$Population!="WT3",]
data$Original_environment <- factor(data$Original_environment)

## Remove Cherry52 which has a very high mean
#data <- data[data$Population!="Cherry52",]
data$Population <- factor(data$Population)
data$Nb_eggs <- as.numeric(as.character(data$Nb_eggs))

data$Row_Col <- as.factor(paste(data$Row, data$Column, sep="_"))

head(data)
sort(unique(data$Nb_eggs))
```
## 3 fruits
### Explore data with blue
```{r }

m0 <- lm(Nb_eggs~Original_environment*Test_environment, data=data[data$Test_environment=="Blackberry"|data$Test_environment=="Cherry"|data$Test_environment=="Strawberry",])

summary(m0)

## Compute proportions
sumeggsperbox <- tapply(data$Nb_eggs, data$Box, sum)
data$sumeggsperbox <- sumeggsperbox[match(as.character(data$Box), names(sumeggsperbox))]
data$prop <-  data$Nb_eggs/data$sumeggsperbox

## Check for local adaptation pattern in proportion
tapply(data$prop[data$Test_environment=="Blackberry"|data$Test_environment=="Cherry"|data$Test_environment=="Strawberry"], list(data$Original_environment[data$Test_environment=="Blackberry"|data$Test_environment=="Cherry"|data$Test_environment=="Strawberry"], data$Test_environment[data$Test_environment=="Blackberry"|data$Test_environment=="Cherry"|data$Test_environment=="Strawberry"]), mean)

## Check for local adaptation pattern in te nulber of eggs
## By pop
tapply(data$Nb_eggs[data$Test_environment=="Blackberry"|data$Test_environment=="Cherry"|data$Test_environment=="Strawberry"], list(data$Population[data$Test_environment=="Blackberry"|data$Test_environment=="Cherry"|data$Test_environment=="Strawberry"], data$Test_environment[data$Test_environment=="Blackberry"|data$Test_environment=="Cherry"|data$Test_environment=="Strawberry"]), mean)

 ## By original environment
tapply(data$Nb_eggs[data$Test_environment=="Blackberry"|data$Test_environment=="Cherry"|data$Test_environment=="Strawberry"], list(data$Original_environment[data$Test_environment=="Blackberry"|data$Test_environment=="Cherry"|data$Test_environment=="Strawberry"], data$Test_environment[data$Test_environment=="Blackberry"|data$Test_environment=="Cherry"|data$Test_environment=="Strawberry"]), mean)

tapply(data$Nb_eggs[data$Test_environment=="Blackberry"|data$Test_environment=="Cherry"|data$Test_environment=="Strawberry"], list(data$Original_environment[data$Test_environment=="Blackberry"|data$Test_environment=="Cherry"|data$Test_environment=="Strawberry"], data$Test_environment[data$Test_environment=="Blackberry"|data$Test_environment=="Cherry"|data$Test_environment=="Strawberry"]), var)

range(data$Nb_eggs)

## Check for the presence of negative correlations after accounting for the heterogeneity between populations (i.e. some lay few or a lot of eggs)
m1 <- lm(log(Nb_eggs+1) ~ Population, data=data[data$Test_environment=="Blackberry"|data$Test_environment=="Cherry"|data$Test_environment=="Strawberry",])
data$resid <- NA
data$resid[data$Test_environment=="Blackberry"|data$Test_environment=="Cherry"|data$Test_environment=="Strawberry"] <- residuals(m1)

meanbypopbytestenv <- as.data.frame(tapply(data$resid[data$Generation=="G2"], list(data$Population[data$Generation=="G2"], data$Test_environment[data$Generation=="G2"]), mean))

## Cherry ~ Blackberry
plot(meanbypopbytestenv$Blackberry, meanbypopbytestenv$Cherry, col=as.numeric(data$Original_environment[match(rownames(meanbypopbytestenv), data$Population)]), xlab="Blackberry", ylab="Cherry", pch=16)
legend("bottomleft", levels(data$Original_environment), col=as.numeric(as.factor(levels(data$Original_environment))), pch=16)

## Strawberry ~ Cherry
plot(meanbypopbytestenv$Cherry, meanbypopbytestenv$Strawberry, col=as.numeric(data$Original_environment[match(rownames(meanbypopbytestenv), data$Population)]), xlab="Cherry", ylab="Strawberry", pch=16)
legend("topright", levels(data$Original_environment), col=as.numeric(as.factor(levels(data$Original_environment))), pch=16)

## Strawberry ~ Blackberry
plot(meanbypopbytestenv$Blackberry~ meanbypopbytestenv$Strawberry, col=as.numeric(data$Original_environment[match(rownames(meanbypopbytestenv), data$Population)]), xlab="Blackberry", ylab="Strawberry", pch=16)
legend("bottomleft", levels(data$Original_environment), col=as.numeric(as.factor(levels(data$Original_environment))), pch=16)

 ```

### Explore data with BLUPS
```{r, eval=FALSE }

m0 <- lmer(log(Nb_eggs+1)~ Population + Test_environment + (0 + Test_environment | Population), data = data[data$Test_environment=="Blackberry"|data$Test_environment=="Cherry"|data$Test_environment=="Strawberry",])

## Correlation between fixed effects
plot(coef(m1), fixef(m0))

summary(m0)

BLUP <- ranef(m0)$Population

pairs(BLUP)

## Positive correlation between blups and blues, as expected
plot(BLUP$Test_environmentBlackberry, meanbypopbytestenv$Blackberry, col=as.numeric(data$Original_environment[match(rownames(meanbypopbytestenv), data$Population)]), pch=16)
legend("topright", levels(data$Original_environment), col=as.numeric(as.factor(levels(data$Original_environment))), pch=16)

## Positive correlation betwen blups and blues, as expected
plot(BLUP$Test_environmentCherry, meanbypopbytestenv$Cherry, col=as.numeric(data$Original_environment[match(rownames(meanbypopbytestenv), data$Population)]), pch=16)
legend("topleft", levels(data$Original_environment), col=as.numeric(as.factor(levels(data$Original_environment))), pch=16)

## Negative correlation betwen blups and blues, weird
plot(BLUP$Test_environmentStrawberry, meanbypopbytestenv$Strawberry, col=as.numeric(data$Original_environment[match(rownames(meanbypopbytestenv), data$Population)]), pch=16)
legend("bottomright", levels(data$Original_environment), col=as.numeric(as.factor(levels(data$Original_environment))), pch=16)

```

### Check that model with box random effect is OK for the analyses for analyses
```{r }
data$SA <- as.factor(ifelse(as.character(data$Original_environment)==as.character(data$Test_environment), 1, 0))
data$Box <- as.factor(data$Box)
data$Obs <- as.factor(1:nrow(data))
npop=3

PopBlackberry <- sort(sample(levels(data$Population)[grep("Blackberry", levels(data$Population))], size=npop, replace = TRUE))
  PopCherry <- sort(sample(levels(data$Population)[grep("Cherry", levels(data$Population))], size=npop, replace = TRUE))
  PopStrawberry <- sort(sample(levels(data$Population)[grep("Strawberry", levels(data$Population))], size=npop, replace = TRUE))
  
m1 <- glmer(Nb_eggs ~ 0 + Original_environment + Test_environment + SA + Original_environment:Test_environment+ (1|Box)+(1|Obs), data=data[(data$Test_environment=="Blackberry"|data$Test_environment=="Cherry"|data$Test_environment=="Strawberry")&data$Population%in%c(PopBlackberry, PopCherry, PopStrawberry),], family="poisson")

summary(m1)

m1bis <- glmer(Nb_eggs ~ 0 + Original_environment + Test_environment + (1|Box)+(1|Obs), data=data[(data$Test_environment=="Blackberry"|data$Test_environment=="Cherry"|data$Test_environment=="Strawberry")&data$Population%in%c(PopBlackberry, PopCherry, PopStrawberry),], family="poisson")

summary(m1bis)

simdata <- function(seed=1, nrep = 1000, npop = 3, SA=FALSE){
  set.seed(seed)

  ## Create dataset
  newdata <- expand.grid(Original_environment=levels(data$Original_environment), Test_environment=c("Blackberry", "Cherry", "Strawberry"), Box=1:nrep)
  newdata$SA <- as.factor(ifelse(as.character(newdata$Original_environment)==as.character(newdata$Test_environment), 1, 0))
  newdata$Box <- as.factor(newdata$Box)
  newdata$Obs <- as.factor(1:nrow(newdata))

  if(SA==TRUE){
    ## Get design matrix
    mat <- model.matrix(~0 + Original_environment + Test_environment + SA +  Original_environment:Test_environment , data=newdata)
    m <- m1
    ## Drop Strawberry x Strawberry interaction which is not identifiable
    mat <- mat[, -ncol(mat)]
  }else{
    mat <- model.matrix(~0 + Original_environment + Test_environment , data=newdata)
    m <- m1bis
  }
  
  ## Check that the order of the coefficients is the same
  data.frame(colnames(mat), names(fixef(m))[names(fixef(m))%in%colnames(mat)])
  
  ## Get the coefficient of the right populations
  coefsim <- fixef(m)[names(fixef(m))%in%colnames(mat)]
  coefsim <- ifelse(is.na(coefsim), 0, coefsim)

  ## Add box random effect
  mat2 <- model.matrix(~0 + Box, data=newdata)
  coefrand <- rnorm(n=nrep, sd=sqrt(data.frame(VarCorr(m))$vcov[2]))
  
  ## Simulate data
  newdata$resp <- exp(mat%*%coefsim + mat2%*%coefrand + rnorm(n=nrow(newdata), mean = 0, sd = sqrt(as.data.frame(VarCorr(m))$vcov[2])))
  
  newdata$Nb_eggs <- sapply(newdata$resp, rpois, n=1)
  if(SA==TRUE){
    ## Check fit of interaction model
  m3 <- glmer(Nb_eggs ~ 0 + Original_environment + Test_environment + SA + Original_environment:Test_environment + (1|Box) + (1|Obs), data=newdata, family="poisson")
  
  data.frame(coefsim, fixef(m3))
  }
  
  
  m4 <- lmer(log(Nb_eggs+1) ~ 0 + Original_environment + Test_environment + SA + Original_environment:Test_environment + (1|Box) , data=newdata)
  
  anova(m4)
  ## F test for SA
  (Fratio_mixed = (anova(m4)[3,2]/anova(m4)[4,2])/(1/anova(m4)[4,1]))
  ## Compute P-value
  (pvalue_mixed = 1 - pf(Fratio_mixed, 1, anova(m4)[4,1]))
  
  ## Fit SA model
  m5 <- lm(log(Nb_eggs+1) ~ Original_environment + Test_environment + SA + Original_environment:Test_environment + Box, data=newdata)
  summary(m5)
  anova(m5)
    
  ## F test for SA
  (Fratio_fixed = (anova(m5)[3,2]/anova(m5)[5,2])/(1/anova(m5)[5,1]))
  ## Compute P-value
  (pvalue_fixed = 1 - pf(Fratio_fixed, 1, anova(m5)[5,1]))
  return(c(Fratio_mixed=Fratio_mixed, pvalue_mixed=pvalue_mixed, Fratio_fixed=Fratio_fixed, pvalue_fixed=pvalue_fixed))
}

simpval <- sapply(1:100, simdata, nrep = 30, npop = 3, SA=TRUE)
## Power of 51%
mean(simpval[2,]<0.05)

## Check false positive rate of 5%
simpval <- sapply(1:100, simdata, nrep = 100, npop = 3, SA=FALSE)
## False positive rate of 5%
mean(simpval[2,]<0.05)


```
### Analysis
```{r }
data$SA <- as.factor(ifelse(as.character(data$Original_environment)==as.character(data$Test_environment), 1, 0))
data$Box <- as.factor(data$Box)

## Model with a box effect
m1 <- lmer(log(Nb_eggs+1) ~ Population + Test_environment + SA + (1|Box) + Original_environment:Test_environment, data=data[data$Test_environment=="Blackberry"|data$Test_environment=="Cherry"|data$Test_environment=="Strawberry",])

## F test for SA with Box effect
(Fratio_int = (anova(m1)[3,2]/anova(m1)[4,2])/(1/anova(m1)[4,1]))
(pvalue_int = 1 - pf(Fratio_int, 1, anova(m1)[4,1])) #the correct test (see equation D7 in Appendix D of the paper)

## Compute Rsquare
(rsq2 <- 1-anova(m1)[4, 3]/((anova(m1)[3, 2]+anova(m1)[4, 2])/(anova(m1)[3, 1]+anova(m1)[4, 1])))

## Model with a box effect and a rwo/col effect
m2 <- lmer(log(Nb_eggs+1) ~ Population + Test_environment + SA + (1|Box) + (1|Row_Col) + Original_environment:Test_environment, data=data[data$Test_environment=="Blackberry"|data$Test_environment=="Cherry"|data$Test_environment=="Strawberry",])

## F test for SA with Box effect
(Fratio_int = (anova(m2)[3,2]/anova(m2)[4,2])/(1/anova(m2)[4,1]))
(pvalue_int = 1 - pf(Fratio_int, 1, anova(m2)[4,1])) #the correct test (see equation D7 in Appendix D of the paper)

## Compute Rsquare
(rsq2 <- 1-anova(m2)[4, 3]/((anova(m2)[3, 2]+anova(m2)[4, 2])/(anova(m2)[3, 1]+anova(m2)[4, 1])))

```

### Power Analysis
```{r , eval=FALSE }

m2 <- lmer(log(Nb_eggs+1) ~ -1 + Population + Test_environment + Original_environment:Test_environment + (1|Box) + (1|Row_Col), data=data[data$Test_environment=="Blackberry"|data$Test_environment=="Cherry"|data$Test_environment=="Strawberry",])
fixef(m2)

simdata <- function(seed=1, nrep = 2, npop = 3){
  #print(seed)
  set.seed(seed)
  ## Sample populations
  PopBlackberry <- sort(sample(levels(data$Population)[grep("Blackberry", levels(data$Population))], size=npop, replace = TRUE))
  PopCherry <- sort(sample(levels(data$Population)[grep("Cherry", levels(data$Population))], size=npop, replace = TRUE))
  PopStrawberry <- sort(sample(levels(data$Population)[grep("Strawberry", levels(data$Population))], size=npop, replace = TRUE))
  
  ## Create dataset
  newdata <- expand.grid(Box=factor(1:nrep), Pop_new_name=1:(3*npop), Test_environment=rep(c("Blackberry", "Cherry", "Strawberry"), each=4))
  newdata$Pop_new_name <- as.factor(newdata$Pop_new_name)
  newdata$Original_environment <- newdata$Pop_new_name
  
  levels(newdata$Original_environment) <- rep(c("Blackberry", "Cherry", "Strawberry"), each=npop)
  newdata$Box <- as.factor(paste(newdata$Box, newdata$Pop_new_name, sep="_"))
  
  #newdata[newdata$Box==2&newdata$Pop_new_name==1,]
  #newdata[newdata$Box=="1_1",]
  #newdata <- newdata[order(newdata$Box),]
  #newdata[newdata$Original_environment=="Blackberry",]

  nlevels(newdata$Box)
  
  ## Add original names to get the right coef in the model
  newdata$Population <- newdata$Pop_new_name
  levels(newdata$Population) <- c(PopBlackberry, PopCherry, PopStrawberry)
  
  unique(newdata$Population)
  
  newdata$Row_Col <- NA
  for (i in levels(newdata$Box)){
    newdata$Row_Col[newdata$Box==i] <- sample(x=1:12, size=12, replace = FALSE)
  }
  newdata$Row_Col <- as.factor(newdata$Row_Col)
  
  ## Get design matrix
  mat <- model.matrix(~-1 + Population + Test_environment + Original_environment:Test_environment, data=newdata)
  ## Remove levels that are not identifiable
  mat <- mat[, !colnames(mat)%in%c("Test_environmentStrawberry:Original_environmentCherry",     "Test_environmentStrawberry:Original_environmentStrawberry")]

  ## Check that the order of the coefficients is the same
  data.frame(colnames(mat), names(fixef(m2))[names(fixef(m2))%in%colnames(mat)])

  ## Get the coefficient of the right populations
  coefsim <- fixef(m2)[names(fixef(m2))%in%colnames(mat)]
  #coefsim <- ifelse(is.na(coefsim), 0, coefsim)

  ## Add box random effect
  mat2 <- model.matrix(~0 + Box, data=newdata)
  coefrand <- rnorm(n=nrep*npop*3, sd=sqrt(data.frame(VarCorr(m2))$vcov[1]))
  
  ## Add row/col random effect
  mat3 <- model.matrix(~0 + Row_Col, data=newdata)
  coefrand2 <- rnorm(n=12, sd=sqrt(data.frame(VarCorr(m2))$vcov[2]))

  ## Simulate data
  newdata$resp <- mat%*%coefsim + mat2%*%coefrand + mat3%*%coefrand2 + rnorm(n=nrow(newdata), mean = 0, sd = sqrt(as.data.frame(VarCorr(m2))$vcov[2]))

  ## Fit interaction model
  m3 <- lmer(resp ~ -1 + Population + Test_environment + Original_environment:Test_environment + (1|Box) + (1|Row_Col), data=newdata)
  data.frame(coefsim, fixef(m3))
  
  ## Fit SA model assuming 9 different populations
  newdata$SA <- as.factor(ifelse(newdata$Original_environment==newdata$Test_environment, 1, 0))
  m4 <- lmer(resp ~ Pop_new_name + Test_environment + SA + Original_environment:Test_environment + (1|Box) + (1|Row_Col), data=newdata)
  summary(m4)
  anova(m4)
    
  ## F test for SA
  (Fratio_int = (anova(m4)[3,2]/anova(m4)[4,2])/(1/anova(m4)[4,1]))
  ## Compute P-value
  (pvalue_int = 1 - pf(Fratio_int, 1, anova(m4)[4,1]))
  return(pvalue_int)
}

simdata(seed=2, nrep = 30, npop = 3)
simpval <- sapply(1:500, simdata, nrep = 10, npop = 3)
mean(simpval)
## Compute power
mean(simpval<0.05)
hist(simpval)

nsim <- 500
simpval10rep <- sapply(1:nsim, simdata, nrep = 10, npop = 3)
simpval15rep <- sapply(1:nsim, simdata, nrep = 15, npop = 3)
simpval20rep <- sapply(1:nsim, simdata, nrep = 20, npop = 3)
simpval25rep <- sapply(1:nsim, simdata, nrep = 25, npop = 3)
simpval30rep <- sapply(1:nsim, simdata, nrep = 30, npop = 3)
simpval35rep <- sapply(1:nsim, simdata, nrep = 35, npop = 3)
simpval40rep <- sapply(1:nsim, simdata, nrep = 40, npop = 3)
simpval60rep <- sapply(1:nsim, simdata, nrep = 60, npop = 3)
simpval80rep <- sapply(1:nsim, simdata, nrep = 80, npop = 3)
simpval100rep <- sapply(1:nsim, simdata, nrep = 100, npop = 3)

## Compute power
val <- data.frame(simpval10rep, simpval15rep, simpval20rep, simpval25rep, simpval30rep, simpval35rep, simpval40rep, simpval60rep, simpval80rep, simpval100rep)

computepower <- function(x){
  return(mean(x<0.05))
}

statpower <- apply(val, 2, computepower)

plot(c(10, 15, 20, 25, 30, 35, 40, 60, 80, 100), statpower, las=1, xlab="Number of replicates", ylab="Statistical Power", main="Preference (3 fruits)")

```

## 12 fruits
### Analysis
```{r }
data$SA <- as.factor(ifelse(as.character(data$Original_environment)==as.character(data$Test_environment), 1, 0))

m1 <- lmer(log(Nb_eggs+1) ~ Population + Test_environment + SA + Original_environment:Test_environment + (1|Box) + (1|Row_Col), data=data[data$Generation=="G2",])
summary(m1)
anova(m1)
  
## F test for SA with Box effect
(Fratio_int = (anova(m1)[3,2]/anova(m1)[4,2])/(1/anova(m1)[4,1]))
(pvalue_int = 1 - pf(Fratio_int, 1, anova(m1)[4,1])) #the correct test (see equation D7 in Appendix D of the paper)

## Compute Rsquare
(rsq2 <- 1-anova(m1)[4, 3]/((anova(m1)[3, 2]+anova(m1)[4, 2])/(anova(m1)[3, 1]+anova(m1)[4, 1])))

```

### Power Analysis
```{r , eval=FALSE }

m2 <- lmer(log(Nb_eggs+1) ~ -1+Population + Test_environment + Original_environment:Test_environment + (1|Box) + (1|Row_Col), data=data[data$Generation=="G2",])

fixef(m2)
hist(log(data$Nb_eggs[data$Generation=="G2"]+1))

simdata <- function(seed=1, nrep = 2, npop = 3){
  set.seed(seed)
  ## Sample populations
  PopBlackberry <- sort(sample(levels(data$Population)[grep("Blackberry", levels(data$Population))], size=npop, replace = TRUE))
  PopCherry <- sort(sample(levels(data$Population)[grep("Cherry", levels(data$Population))], size=npop, replace = TRUE))
  PopStrawberry <- sort(sample(levels(data$Population)[grep("Strawberry", levels(data$Population))], size=npop, replace = TRUE))
  
  ## Create dataset
  newdata <- expand.grid(Pop_new_name=1:(3*npop), Test_environment=levels(data$Test_environment), Box=factor(1:nrep))
  newdata$Original_environment <- rep(c("Blackberry", "Cherry", "Strawberry"), each=npop)
  
  
  ## Add original names to get the right coef in the model
  newdata$Pop_new_name <- as.factor(newdata$Pop_new_name)
  newdata$Population <- newdata$Pop_new_name
  levels(newdata$Population) <- c(PopBlackberry, PopCherry, PopStrawberry)
  newdata$Box <- as.factor(paste(newdata$Box, newdata$Pop_new_name, sep="_"))
  #newdata[newdata$Pop_new_name=="1",]
  #newdata[order(newdata$Box),]
  #nlevels(newdata$Box)
  unique(newdata$Population)
  
  newdata$Row_Col <- NA
  for (i in levels(newdata$Box)){
    newdata$Row_Col[newdata$Box==i] <- sample(x=1:12, size=12, replace = FALSE)
  }
  newdata$Row_Col <- as.factor(newdata$Row_Col)
  
  ## Get design matrix
  mat <- model.matrix(~-1 + Population + Test_environment + Original_environment:Test_environment, data=newdata)
  ## Remove levels that are not identifiable
  mat <- mat[, !colnames(mat)%in%colnames(mat)[!colnames(mat)%in%names(fixef(m2))]]
  
  ## Check that the order of the coefficients is the same
  data.frame(colnames(mat), names(fixef(m2))[names(fixef(m2))%in%colnames(mat)])
  
  coefsim <- fixef(m2)[names(fixef(m2))%in%colnames(mat)]
  #coefsim <- ifelse(is.na(coefsim), 0, coefsim)
  
  ## Add box random effect
  mat2 <- model.matrix(~0 + Box, data=newdata)
  coefrand <- rnorm(n=nrep*npop*3, sd=sqrt(data.frame(VarCorr(m2))$vcov[1]))
  
  ## Add row/col random effect
  mat3 <- model.matrix(~0 + Row_Col, data=newdata)
  coefrand2 <- rnorm(n=12, sd=sqrt(data.frame(VarCorr(m2))$vcov[2]))
  
  ## Simulate data
  newdata$resp <- mat%*%coefsim + mat2%*%coefrand + mat3%*%coefrand2 + rnorm(n=nrow(newdata), mean = 0, sd = sqrt(as.data.frame(VarCorr(m2))$vcov[3]))

  m3 <- lmer(resp ~ -1 + Population + Test_environment + Original_environment:Test_environment + (1|Box) + (1|Row_Col), data=newdata)
  
  data.frame(coefsim, fixef(m3))
  
  newdata$SA <- as.factor(ifelse(newdata$Original_environment==newdata$Test_environment, 1, 0))
  
  m4 <- lmer(resp ~ Pop_new_name + Test_environment + SA + Original_environment:Test_environment + (1|Box) + (1|Row_Col), data=newdata)
  summary(m4)
  anova(m4)
    
  ## F test for SA
  (Fratio_int = (anova(m4)[3,2]/anova(m4)[4,2])/(1/anova(m4)[4,1]))
  (pvalue_int = 1 - pf(Fratio_int, 1, anova(m4)[4,1])) #the correct test (see equation D7 in Appendix D of the paper)
  return(pvalue_int)
}

simdata(seed=2, nrep = 30, npop = 3)
simpval <- sapply(1:500, simdata, nrep = 10, npop = 3)
mean(simpval)
## Compute power
mean(simpval<0.05)
hist(simpval)

nsim <- 500
simpval10rep <- sapply(1:nsim, simdata, nrep = 10, npop = 3)
simpval15rep <- sapply(1:nsim, simdata, nrep = 15, npop = 3)
simpval20rep <- sapply(1:nsim, simdata, nrep = 20, npop = 3)
simpval25rep <- sapply(1:nsim, simdata, nrep = 25, npop = 3)
simpval30rep <- sapply(1:nsim, simdata, nrep = 30, npop = 3)
simpval35rep <- sapply(1:nsim, simdata, nrep = 35, npop = 3)
simpval40rep <- sapply(1:nsim, simdata, nrep = 40, npop = 3)
simpval60rep <- sapply(1:nsim, simdata, nrep = 60, npop = 3)
simpval80rep <- sapply(1:nsim, simdata, nrep = 80, npop = 3)
simpval100rep <- sapply(1:nsim, simdata, nrep = 100, npop = 3)

## Compute power
val <- data.frame(simpval10rep, simpval15rep, simpval20rep, simpval25rep, simpval30rep, simpval35rep, simpval40rep, simpval60rep, simpval80rep, simpval100rep)

computepower <- function(x){
  return(mean(x<0.05))
}

statpower <- apply(val, 2, computepower)

plot(c(10, 15, 20, 25, 30, 35, 40, 60, 80, 100), statpower, las=1, xlab="Number of replicates", ylab="Statistical Power", main="Preference (12 fruits)")

```