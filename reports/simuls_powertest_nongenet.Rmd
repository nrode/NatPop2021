---
title: "Power test: detection non genetic local adaptation"
author: "Laure Olazcuaga, Nicolas Rode"
date: "`r format(Sys.Date(), '%d-%B-%Y')`"
output: 
  html_document:
    theme: "journal"
    toc: true
    toc_depth: 3
    number_sections: true
    toc_float:
      collapsed: false
      smooth_scroll: false
editor_options: 
  chunk_output_type: console
---


```{r setup, include =FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
devtools::load_all()
```



# DATA 
```{r }
#############################
#PERFORMANCE 
#############################

data_PERF <- import_data(dataset = "DATACOMPLET_PERF.csv", 
                         trait = "performance",
                         remove_testenvt = c("Grape","GF"), 
                         remove_pop = "WT3", 
                         remove_rate = NA)

tapply(data_PERF$Nb_adults,list(data_PERF$Original_environment,data_PERF$Generation),length)

#############################
#EMERGENCE RATE
#############################

data_PERF_Rate <- import_data(dataset = "DATACOMPLET_PERF.csv", 
                         trait = "performance",
                         remove_testenvt = c("Grape","GF"), 
                         remove_pop = "WT3", 
                         remove_rate = TRUE)


###########################
#PREFERENCE 
###########################
data_PREF <- import_data(dataset = "DATACOMPLET_PREF.csv", 
                         trait = "preference",
                         remove_testenvt = NA, 
                         remove_pop = "WT3", 
                         remove_rate = NA)

head(data_PREF)
tapply(data_PREF$Nb_eggs,list(data_PREF$Original_environment,data_PREF$Generation),length)



###########################
#PREFERENCE 3 fruits
###########################
levels_test<-levels(data_PREF$Test_environment)
levels_original<-levels(data_PREF$Original_environment)


data_PREF_three <- import_data(dataset = "DATACOMPLET_PREF.csv", 
                         trait = "preference",
                         remove_testenvt = usefun::outersect(levels_test, 
                                                             levels_original), 
                         remove_pop = "WT3", 
                         remove_rate = NA)

head(data_PREF_three)
tapply(data_PREF_three$Nb_eggs,list(data_PREF_three$Original_environment,
                                    data_PREF_three$Generation),length)



dim(data_PREF_three)
dim(data_PREF)



```


# Simulations Rate
```{r }
##### MODEL 
## Model to extract value of our dataset
m <- lme4::lmer(asin(sqrt(Rate)) ~ SA + SA*IndicG0 + Test_environment:Generation  +
                  (1|Population:Test_environment) + 
                  (0 + lme4::dummy(Generation, "G0")|Population:Test_environment),
                data = data_PERF_Rate)
summary(m)


fixef_m <- lme4::fixef(m)  #Mean with the fixed effects
random_m <- data.frame(lme4::VarCorr(m))$vcov #var with the random effect

##### SIMULATED DATASTE 
## New dataset for the simulated data
sim_data <- data_PERF_Rate


## Design matrix for the simulated data
M1 <- model.matrix(~ SA + SA*IndicG0 + Test_environment:Generation,
                   data = sim_data)
dim(M1)
dim(sim_data)
head(M1)
head(sim_data)

##### FIXED EFFECT
## Compute the breeding value of each individual in the new dataset
#For 2 columns dropping problem:
M1 <- M1[, colnames(M1)%in%names(fixef_m)] 
dim(M1)
head(M1)

#Extract fixef(m)
sim_data$FixEff <- M1%*%fixef_m

#Check: correspond to do a predict without considered ramdom effects: 
#data.frame(M1%*%fixef_m,predict(m, re.form = NA))




##### RANDOM EFFECT
# Add variation Population:Test_environment
sim_data$RandomEff1 <-  as.factor(paste(sim_data$Population, 
                                        sim_data$Test_environment, sep = "_"))
levels(sim_data$RandomEff1) <- rnorm(nlevels(sim_data$RandomEff1), 0, sd = sqrt(random_m[1]))
sim_data$RandomEff1 <- as.numeric(as.character(sim_data$RandomEff1))


# Add variation Population:Test_environment:G0
sim_data$RandomEff2 <-  as.factor(paste(sim_data$Population, 
                                        sim_data$Test_environment,
                                        sim_data$Generation, sep = "_"))
levels(sim_data$RandomEff2) <- rnorm(nlevels(sim_data$RandomEff2), 0, sd = sqrt(random_m[2]))
sim_data$RandomEff2 <- as.numeric(as.character(sim_data$RandomEff2))
## When generation G2, replace RandomEff2 by 0
sim_data$RandomEff2 <- ifelse(sim_data$Generation == "G2", 0, sim_data$RandomEff2)
  


##### ERROR TERM
## Compute the random environmental error
varres <- sigma(m)
sim_data$ResEff <- rnorm(n=nrow(sim_data), mean = 0, sd = varres)


##### FITNESS
## Compute the fitness total
sim_data$y <- sim_data$FixEff + sim_data$RandomEff1 + sim_data$RandomEff2 + sim_data$ResEff



# 
# install.packages("asreml")
# library("asreml")
# 
# 

```